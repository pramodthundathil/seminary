{% extends 'admin/index.html' %}
{% block content %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<div class="gallery-container">
    <div class="page-header">
        <h1>
            
            Slider Management
        </h1>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openCreateModal()">
                <i class="fas fa-plus-circle"></i>
                Create Slider
            </button>
        </div>
    </div>

    <div class="content-card">
        <div class="table-container">
            <table id="slidersTable" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Slider Info</th>
                        <th>Dimensions</th>
                        <th>Photos</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- DataTables will populate this -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="sliderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle"><i class="fas fa-plus-circle"></i> Create Slider</h2>
            <button class="close-modal" onclick="closeSliderModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="sliderForm">
                {% csrf_token %}
                <input type="hidden" id="sliderId" name="slider_id">

                <div class="form-group">
                    <label class="form-label required" for="sliderName">Slider Name</label>
                    <input type="text" class="form-control" id="sliderName" name="slider_name"
                        placeholder="e.g., Homepage Banner" required>
                </div>

                <div class="form-group">
                    <label class="form-label required" for="sliderCode">Slider Code</label>
                    <input type="text" class="form-control" id="sliderCode" name="code" placeholder="e.g., home_banner"
                        required>
                    <small style="color: var(--text-gray); margin-top: 5px; display: block;">
                        Unique identifier for this slider (lowercase, no spaces)
                    </small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required" for="sliderWidth">Width (px)</label>
                        <input type="number" class="form-control" id="sliderWidth" name="width" placeholder="1920"
                            min="1" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label required" for="sliderHeight">Height (px)</label>
                        <input type="number" class="form-control" id="sliderHeight" name="height" placeholder="1080"
                            min="1" required>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeSliderModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn btn-primary" onclick="saveSlider()">
                <i class="fas fa-save"></i> Save Slider
            </button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
    let isEditMode = false;
    let table;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    $(document).ready(function() {
        table = $('#slidersTable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: '{% url "slider_datatable" %}',
                type: 'GET'
            },
            columns: [
                { data: 'id', width: '60px' },
                { data: 'slider_info', orderable: false, width: '300px' },
                { data: 'dimensions', width: '120px' },
                { data: 'photos', width: '80px' },
                { data: 'created_at', width: '120px' },
                { data: 'actions', orderable: false, width: '150px' }
            ],
            pageLength: 12,
            lengthMenu: [[12, 24, 48, 96], [12, 24, 48, 96]],
            order: [[0, 'desc']],
            language: {
                search: "Search:",
                lengthMenu: "Show _MENU_ sliders",
                info: "Showing _START_ to _END_ of _TOTAL_ sliders",
                infoEmpty: "Showing 0 to 0 of 0 sliders",
                infoFiltered: "(filtered from _MAX_ total sliders)",
                zeroRecords: "No matching sliders found",
                emptyTable: "No sliders available"
            }
        });
    });

    function openCreateModal() {
        isEditMode = false;
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Create Slider';
        document.getElementById('sliderForm').reset();
        document.getElementById('sliderId').value = '';
        document.getElementById('sliderModal').style.display = 'block';
    }

    function closeSliderModal() {
        document.getElementById('sliderModal').style.display = 'none';
    }

    async function editSlider(sliderId) {
        try {
            const response = await fetch(`/menu/sliders/get/${sliderId}/`);
            const result = await response.json();

            if (result.success) {
                isEditMode = true;
                document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Slider';
                document.getElementById('sliderId').value = result.data.id;
                document.getElementById('sliderName').value = result.data.slider_name;
                document.getElementById('sliderCode').value = result.data.code;
                document.getElementById('sliderWidth').value = result.data.width;
                document.getElementById('sliderHeight').value = result.data.height;
                document.getElementById('sliderModal').style.display = 'block';
            } else {
                alert('Error loading slider: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to load slider data');
        }
    }

    async function saveSlider() {
        const form = document.getElementById('sliderForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const sliderId = document.getElementById('sliderId').value;
        const url = isEditMode ? `/menu/sliders/update/${sliderId}/` : '{% url "slider_create" %}';
        const csrftoken = getCookie('csrftoken');

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                alert(isEditMode ? 'Slider updated successfully!' : 'Slider created successfully!');
                closeSliderModal();
                table.ajax.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to save slider');
        }
    }

    async function deleteSlider(sliderId, sliderName) {
        if (!confirm(`Are you sure you want to delete "${sliderName}"?\n\nThis will also delete all associated photos. This action cannot be undone.`)) {
            return;
        }

        const csrftoken = getCookie('csrftoken');

        try {
            const response = await fetch(`/menu/sliders/delete/${sliderId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                alert('Slider deleted successfully!');
                table.ajax.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to delete slider');
        }
    }

    function managePhotos(sliderId) {
        window.location.href = `/menu/sliders/${sliderId}/photos/`;
    }

    // Close modal on outside click
    window.onclick = function (event) {
        const modal = document.getElementById('sliderModal');
        if (event.target === modal) {
            closeSliderModal();
        }
    }
</script>

<style>
    .slider-info {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .slider-name {
        font-weight: 600;
        font-size: 15px;
        color: var(--text-dark);
    }
    
    .slider-meta {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .code-badge {
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .dimension-badge {
        background: #f3e5f5;
        color: #7b1fa2;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .photo-count-badge {
        background: #e8f5e9;
        color: #388e3c;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
    }
    
    .btn-action {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .btn-photos {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .btn-photos:hover {
        background: #1976d2;
        color: white;
    }
    
    .btn-edit {
        background: #fff3e0;
        color: #f57c00;
    }
    
    .btn-edit:hover {
        background: #f57c00;
        color: white;
    }
    
    .btn-delete {
        background: #ffebee;
        color: #c62828;
    }
    
    .btn-delete:hover {
        background: #c62828;
        color: white;
    }
</style>

{% endblock %}