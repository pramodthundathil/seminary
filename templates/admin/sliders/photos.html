{% extends 'admin/index.html' %}
{% block content %}

<style>
    :root {
        --primary-purple: #8B5CF6;
        --purple-light: #F3E8FF;
        --dark-navy: #1B2845;
        --cyan-accent: #00CED1;
        --green-success: #10B981;
        --red-danger: #EF4444;
        --blue-info: #3B82F6;
        --text-gray: #6B7280;
        --border-gray: #E5E7EB;
    }

    * {
        font-family: 'Roboto Condensed', sans-serif;
    }

    .photos-container {
        padding: 30px;
        background: linear-gradient(135deg, var(--purple-light) 0%, #fff 100%);
        min-height: 100vh;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 25px 30px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.1);
    }

    .header-content h1 {
        color: var(--dark-navy);
        font-size: 28px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 15px;
        margin: 0 0 10px 0;
    }

    .slider-info-header {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .info-badge {
        padding: 6px 14px;
        background: linear-gradient(135deg, var(--primary-purple), #A78BFA);
        color: white;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-purple), #A78BFA);
        color: white;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(139, 92, 246, 0.4);
    }

    .btn-secondary {
        background: var(--text-gray);
        color: white;
    }

    .btn-secondary:hover {
        background: #4B5563;
        transform: translateY(-2px);
    }

    .content-card {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    }

    /* DataTable Styling */
    table.dataTable {
        width: 100% !important;
        border-collapse: separate;
        border-spacing: 0 10px;
    }

    table.dataTable thead th {
        background: linear-gradient(135deg, var(--dark-navy), #2A3F5F);
        color: white;
        padding: 18px 20px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 13px;
        letter-spacing: 1px;
        border: none;
    }

    table.dataTable thead th:first-child {
        border-radius: 12px 0 0 12px;
    }

    table.dataTable thead th:last-child {
        border-radius: 0 12px 12px 0;
    }

    table.dataTable tbody tr {
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        transition: all 0.3s ease;
    }

    table.dataTable tbody tr:hover {
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.15);
        transform: translateY(-3px);
    }

    table.dataTable tbody td {
        padding: 20px;
        vertical-align: middle;
        border: none;
    }

    .photo-preview {
        width: 120px;
        height: 80px;
        object-fit: cover;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .photo-preview:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .photo-info {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .photo-title {
        font-weight: 700;
        color: var(--dark-navy);
        font-size: 15px;
    }

    .photo-button-info {
        display: flex;
        gap: 8px;
    }

    .button-badge {
        padding: 4px 10px;
        background: var(--green-success);
        color: white;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
    }

    .btn-action {
        width: 38px;
        height: 38px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        color: white;
        font-size: 14px;
    }

    .btn-view {
        background: var(--cyan-accent);
    }

    .btn-view:hover {
        background: #00B8BA;
        transform: scale(1.1);
    }

    .btn-edit {
        background: var(--blue-info);
    }

    .btn-edit:hover {
        background: #2563EB;
        transform: scale(1.1) rotate(-5deg);
    }

    .btn-delete {
        background: var(--red-danger);
    }

    .btn-delete:hover {
        background: #DC2626;
        transform: scale(1.1);
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(27, 40, 69, 0.85);
        backdrop-filter: blur(8px);
        animation: fadeIn 0.3s ease;
        overflow-y: auto;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background: white;
        margin: 40px auto;
        padding: 0;
        border-radius: 20px;
        width: 90%;
        max-width: 900px;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        background: linear-gradient(135deg, var(--primary-purple), #A78BFA);
        color: white;
        padding: 25px 30px;
        border-radius: 20px 20px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .close-modal {
        color: white;
        font-size: 28px;
        font-weight: 300;
        cursor: pointer;
        border: none;
        background: none;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .close-modal:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 30px;
        max-height: calc(90vh - 200px);
        overflow-y: auto;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: var(--dark-navy);
        margin-bottom: 8px;
        font-size: 14px;
    }

    .form-label.required::after {
        content: "*";
        color: var(--red-danger);
        margin-left: 4px;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-gray);
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s ease;
        font-family: 'Roboto Condensed', sans-serif;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-purple);
        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    /* Media Library Selector */
    .media-selector {
        border: 3px dashed var(--cyan-accent);
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        background: var(--purple-light);
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
    }

    .media-selector:hover {
        border-color: var(--primary-purple);
        background: #E9D5FF;
    }

    .media-selector.has-media {
        border-style: solid;
        border-color: var(--green-success);
        background: #ECFDF5;
    }

    .media-selector-icon {
        font-size: 48px;
        color: var(--cyan-accent);
        margin-bottom: 15px;
    }

    .media-selector-text {
        font-size: 16px;
        color: var(--dark-navy);
        font-weight: 600;
    }

    .selected-media-preview {
        display: none;
        margin-top: 15px;
    }

    .selected-media-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .modal-footer {
        padding: 20px 30px;
        border-top: 2px solid var(--purple-light);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .btn-cancel {
        background: var(--text-gray);
        color: white;
    }

    .btn-cancel:hover {
        background: #4B5563;
    }

    /* Media Library Modal */
    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
    }

    .media-item {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid transparent;
    }

    .media-item:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
    }

    .media-item.selected {
        border-color: var(--green-success);
        transform: scale(1.05);
    }

    .media-item img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }

    .media-item-check {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        background: var(--green-success);
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
    }

    .media-item.selected .media-item-check {
        display: flex;
    }

    /* View Modal Styles */
    .photo-detail-preview {
        text-align: center;
        margin-bottom: 25px;
    }

    .photo-detail-preview img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }

    .detail-item {
        padding: 15px;
        background: var(--purple-light);
        border-radius: 10px;
    }

    .detail-label {
        font-size: 12px;
        color: var(--text-gray);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .detail-value {
        font-size: 15px;
        color: var(--dark-navy);
        font-weight: 600;
    }

    .detail-description {
        padding: 20px;
        background: var(--purple-light);
        border-radius: 10px;
    }

    .detail-description h3 {
        color: var(--dark-navy);
        font-size: 16px;
        font-weight: 700;
        margin: 0 0 10px 0;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .detail-grid {
            grid-template-columns: 1fr;
        }

        .media-grid {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
    }
</style>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

<div class="photos-container">
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i class="fas fa-images"></i>
                Slider Photos
            </h1>
            <div class="slider-info-header">
                <span class="info-badge">{{ slider.slider_name }}</span>
                <span class="info-badge">{{ slider.width }}x{{ slider.height }}</span>
                <span class="info-badge">Code: {{ slider.code }}</span>
            </div>
        </div>
        <div class="header-actions">
            <a href="{% url 'slider_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Sliders
            </a>
            <button class="btn btn-primary" onclick="openAddPhotoModal()">
                <i class="fas fa-plus-circle"></i>
                Add Photo
            </button>
        </div>
    </div>

    <div class="content-card">
        <table id="photosTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Preview</th>
                    <th>Info</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data loaded via AJAX -->
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Photo Modal -->
<div id="photoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle"><i class="fas fa-plus-circle"></i> Add Photo</h2>
            <button class="close-modal" onclick="closePhotoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="photoForm">
                {% csrf_token %}
                <input type="hidden" id="photoId" name="photo_id">
                <input type="hidden" id="selectedMediaId" name="media_id">

                <div class="form-group" id="mediaSelectorGroup">
                    <label class="form-label required">Select Image</label>
                    <div class="media-selector" onclick="openMediaLibrary()">
                        <div class="media-selector-icon">
                            <i class="fas fa-image"></i>
                        </div>
                        <div class="media-selector-text">Click to select image from library</div>
                        <div class="selected-media-preview" id="selectedMediaPreview">
                            <img id="selectedMediaImg" src="" alt="">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="photoTitle">Title</label>
                    <input type="text" class="form-control" id="photoTitle" name="title" 
                           placeholder="Enter photo title">
                </div>

                <div class="form-group">
                    <label class="form-label" for="photoDescription">Description</label>
                    <textarea class="form-control" id="photoDescription" name="description" 
                              placeholder="Enter description"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="photoAltText">Alt Text</label>
                    <input type="text" class="form-control" id="photoAltText" name="alt_text" 
                           placeholder="For accessibility">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="buttonText">Button Text</label>
                        <input type="text" class="form-control" id="buttonText" name="button_text" 
                               placeholder="e.g., Learn More">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="buttonLink">Button Link</label>
                        <input type="text" class="form-control" id="buttonLink" name="button_link" 
                               placeholder="https://">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="buttonLinkTarget">Button Link Target</label>
                    <select class="form-control" id="buttonLinkTarget" name="button_link_target">
                        <option value="_self">Same Window</option>
                        <option value="_blank">New Window</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closePhotoModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn btn-primary" onclick="savePhoto()">
                <i class="fas fa-save"></i> Save Photo
            </button>
        </div>
    </div>
</div>

<!-- Media Library Modal -->
<div id="mediaLibraryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-photo-video"></i> Select from Media Library</h2>
            <button class="close-modal" onclick="closeMediaLibrary()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <input type="text" class="form-control" id="mediaSearch" 
                       placeholder="Search media..." onkeyup="searchMedia()">
            </div>
            <div class="media-grid" id="mediaGrid">
                <!-- Media items loaded dynamically -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeMediaLibrary()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn btn-primary" onclick="selectMedia()">
                <i class="fas fa-check"></i> Select
            </button>
        </div>
    </div>
</div>

<!-- View Photo Modal -->
<div id="viewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-eye"></i> Photo Details</h2>
            <button class="close-modal" onclick="closeViewModal()">&times;</button>
        </div>
        <div class="modal-body" id="viewModalContent">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
let photosTable;
let isEditMode = false;
let ckeditorInstance = null;
let selectedMedia = null;
let mediaLibraryData = [];

const sliderId = {{ slider.id }};

$(document).ready(function() {
    photosTable = $('#photosTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: `/admin/sliders/${sliderId}/photos/datatable/`,
            type: 'GET',
            error: function(xhr, error, code) {
                console.error('DataTables Error:', error);
                console.error('Response:', xhr.responseText);
                alert('Error loading photos: ' + error + '\nCheck console for details.');
            }
        },
        columns: [
            { data: 'id', width: '60px' },
            { data: 'preview', orderable: false, searchable: false, width: '140px' },
            { data: 'info' },
            { data: 'created_at', width: '110px' },
            { data: 'actions', orderable: false, searchable: false, width: '140px' }
        ],
        order: [[0, 'desc']],
        pageLength: 12,
        lengthMenu: [[12, 24, 48], [12, 24, 48]],
        language: {
            search: "Search:",
            lengthMenu: "Show _MENU_ items",
            info: "Showing _START_ to _END_ of _TOTAL_ photos"
        }
    });

    // Initialize CKEditor
    initCKEditor();
});

function initCKEditor() {
    if (ckeditorInstance) {
        ckeditorInstance.destroy();
    }
    
    ckeditorInstance = CKEDITOR.replace('photoDescription', {
        height: 250,
        toolbar: [
            { name: 'document', items: ['Source'] },
            { name: 'clipboard', items: ['Undo', 'Redo'] },
            { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike'] },
            { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
            { name: 'links', items: ['Link', 'Unlink'] },
            { name: 'insert', items: ['Image', 'Table', 'HorizontalRule'] },
            { name: 'styles', items: ['Format', 'Font', 'FontSize'] },
            { name: 'colors', items: ['TextColor', 'BGColor'] }
        ]
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function openAddPhotoModal() {
    isEditMode = false;
    selectedMedia = null;
    
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Add Photo';
    document.getElementById('photoForm').reset();
    document.getElementById('photoId').value = '';
    document.getElementById('selectedMediaId').value = '';
    
    // Reset media selector
    const mediaSelector = document.querySelector('.media-selector');
    mediaSelector.classList.remove('has-media');
    document.getElementById('selectedMediaPreview').style.display = 'none';
    document.getElementById('mediaSelectorGroup').style.display = 'block';
    
    // Reset CKEditor
    if (ckeditorInstance) {
        ckeditorInstance.setData('');
    }
    
    document.getElementById('photoModal').style.display = 'block';
}

function closePhotoModal() {
    document.getElementById('photoModal').style.display = 'none';
}

async function editPhoto(photoId) {
    try {
        const response = await fetch(`/admin/sliders/photos/get/${photoId}/`);
        const result = await response.json();

        if (result.success) {
            isEditMode = true;
            const data = result.data;
            
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Photo';
            document.getElementById('photoId').value = data.id;
            document.getElementById('selectedMediaId').value = data.media_id;
            document.getElementById('photoTitle').value = data.title;
            document.getElementById('photoAltText').value = data.alt_text;
            document.getElementById('buttonText').value = data.button_text;
            document.getElementById('buttonLink').value = data.button_link;
            document.getElementById('buttonLinkTarget').value = data.button_link_target;
            
            // Set CKEditor content
            if (ckeditorInstance) {
                ckeditorInstance.setData(data.description);
            }
            
            // Show selected media
            selectedMedia = {
                id: data.media_id,
                url: data.media_url
            };
            
            const mediaSelector = document.querySelector('.media-selector');
            mediaSelector.classList.add('has-media');
            document.getElementById('selectedMediaImg').src = data.media_url;
            document.getElementById('selectedMediaPreview').style.display = 'block';
            
            // Hide media selector in edit mode
            document.getElementById('mediaSelectorGroup').style.display = 'none';
            
            document.getElementById('photoModal').style.display = 'block';
        } else {
            alert('Error loading photo: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to load photo data');
    }
}

async function savePhoto() {
    if (!isEditMode && !selectedMedia) {
        alert('Please select an image from the media library');
        return;
    }
    
    const form = document.getElementById('photoForm');
    const formData = new FormData(form);
    
    // Get CKEditor content
    if (ckeditorInstance) {
        formData.set('description', ckeditorInstance.getData());
    }
    
    const photoId = document.getElementById('photoId').value;
    const url = isEditMode ? 
        `/admin/sliders/photos/update/${photoId}/` : 
        `/admin/sliders/${sliderId}/photos/create/`;
    
    const csrftoken = getCookie('csrftoken');

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            alert(isEditMode ? 'Photo updated successfully!' : 'Photo added successfully!');
            closePhotoModal();
            photosTable.ajax.reload();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to save photo');
    }
}

async function deletePhoto(photoId) {
    if (!confirm('Are you sure you want to delete this photo?\n\nThis action cannot be undone.')) {
        return;
    }

    const csrftoken = getCookie('csrftoken');

    try {
        const response = await fetch(`/admin/sliders/photos/delete/${photoId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        });

        const result = await response.json();

        if (result.success) {
            alert('Photo deleted successfully!');
            photosTable.ajax.reload();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete photo');
    }
}

async function viewPhoto(photoId) {
    try {
        const response = await fetch(`/admin/sliders/photos/get/${photoId}/`);
        const result = await response.json();

        if (result.success) {
            const data = result.data;
            
            let buttonInfo = '';
            if (data.button_text || data.button_link) {
                buttonInfo = `
                    <div class="detail-item">
                        <div class="detail-label">Button</div>
                        <div class="detail-value">${data.button_text || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Button Link</div>
                        <div class="detail-value" style="word-break: break-all;">${data.button_link || '-'}</div>
                    </div>
                `;
            }
            
            const content = `
                <div class="photo-detail-preview">
                    <img src="${data.media_url}" alt="${data.alt_text || data.title}">
                </div>
                
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Title</div>
                        <div class="detail-value">${data.title || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Alt Text</div>
                        <div class="detail-value">${data.alt_text || '-'}</div>
                    </div>
                    ${buttonInfo}
                    <div class="detail-item">
                        <div class="detail-label">Link Target</div>
                        <div class="detail-value">${data.button_link_target === '_blank' ? 'New Window' : 'Same Window'}</div>
                    </div>
                </div>
                
                ${data.description ? `
                    <div class="detail-description">
                        <h3>Description</h3>
                        <div>${data.description}</div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('viewModalContent').innerHTML = content;
            document.getElementById('viewModal').style.display = 'block';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to load photo details');
    }
}

function closeViewModal() {
    document.getElementById('viewModal').style.display = 'none';
}

// Media Library Functions
async function openMediaLibrary() {
    try {
        const response = await fetch('/admin/media/datatable/?length=1000');
        const result = await response.json();
        
        if (result.data) {
            mediaLibraryData = result.data;
            renderMediaGrid();
            document.getElementById('mediaLibraryModal').style.display = 'block';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to load media library');
    }
}

function closeMediaLibrary() {
    document.getElementById('mediaLibraryModal').style.display = 'none';
}

function renderMediaGrid(filteredData = null) {
    const data = filteredData || mediaLibraryData;
    const grid = document.getElementById('mediaGrid');
    grid.innerHTML = '';
    
    data.forEach(item => {
        // Extract image URL from preview HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = item.preview;
        const img = tempDiv.querySelector('img');
        
        if (img) {
            const mediaItem = document.createElement('div');
            mediaItem.className = 'media-item';
            mediaItem.dataset.mediaId = item.id;
            mediaItem.dataset.mediaUrl = img.src;
            
            if (selectedMedia && selectedMedia.id == item.id) {
                mediaItem.classList.add('selected');
            }
            
            mediaItem.innerHTML = `
                <img src="${img.src}" alt="">
                <div class="media-item-check">
                    <i class="fas fa-check"></i>
                </div>
            `;
            
            mediaItem.onclick = function() {
                // Remove previous selection
                document.querySelectorAll('.media-item').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Add selection
                this.classList.add('selected');
                selectedMedia = {
                    id: this.dataset.mediaId,
                    url: this.dataset.mediaUrl
                };
            };
            
            grid.appendChild(mediaItem);
        }
    });
}

function searchMedia() {
    const searchTerm = document.getElementById('mediaSearch').value.toLowerCase();
    
    if (!searchTerm) {
        renderMediaGrid();
        return;
    }
    
    const filtered = mediaLibraryData.filter(item => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = item.info;
        const text = tempDiv.textContent.toLowerCase();
        return text.includes(searchTerm);
    });
    
    renderMediaGrid(filtered);
}

function selectMedia() {
    if (!selectedMedia) {
        alert('Please select an image');
        return;
    }
    
    document.getElementById('selectedMediaId').value = selectedMedia.id;
    document.getElementById('selectedMediaImg').src = selectedMedia.url;
    document.getElementById('selectedMediaPreview').style.display = 'block';
    
    const mediaSelector = document.querySelector('.media-selector');
    mediaSelector.classList.add('has-media');
    
    closeMediaLibrary();
}

// Close modals on outside click
window.onclick = function(event) {
    const photoModal = document.getElementById('photoModal');
    const mediaModal = document.getElementById('mediaLibraryModal');
    const viewModal = document.getElementById('viewModal');
    
    if (event.target === photoModal) {
        closePhotoModal();
    }
    if (event.target === mediaModal) {
        closeMediaLibrary();
    }
    if (event.target === viewModal) {
        closeViewModal();
    }
}
</script>

{% endblock %}