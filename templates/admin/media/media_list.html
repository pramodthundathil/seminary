{% extends 'admin/index.html' %}
{% load static %}
{% block content %}



<div class="media-container">
    <div class="page-header">
        <h1>Media Library</h1>
        <button class="btn btn-primary" onclick="openUploadModal()">Upload New</button>
    </div>

    <div class="controls-bar">
        <div class="search-row">
            <div class="search-box">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Search media files..."
                    value="{{ current_search }}"
                >
            </div>
            <button class="btn btn-secondary" onclick="applyFilters()">Search</button>
        </div>

        <div class="filter-tabs">
            <button class="filter-tab {% if not current_type %}active{% endif %}" data-type="">All</button>
            <button class="filter-tab {% if current_type == 'image' %}active{% endif %}" data-type="image">Images</button>
            <button class="filter-tab {% if current_type == 'video' %}active{% endif %}" data-type="video">Videos</button>
            <button class="filter-tab {% if current_type == 'document' %}active{% endif %}" data-type="document">Documents</button>
            <button class="filter-tab {% if current_type == 'other' %}active{% endif %}" data-type="other">Other</button>
        </div>
    </div>

    <div class="media-grid">
        {% if media_items %}
            {% for item in media_items %}
            <div class="media-card">
                <div class="media-thumbnail">
                    {% if item.media_type == 'image' %}
                        <img src="{{ item.thumb_url }}" alt="{{ item.alt_text }}">
                    {% elif item.media_type == 'video' %}
                        <svg width="60" height="60" fill="#94A3B8" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    {% elif item.media_type == 'document' %}
                        <svg width="60" height="60" fill="#94A3B8" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"/></svg>
                    {% else %}
                        <svg width="60" height="60" fill="#94A3B8" viewBox="0 0 24 24"><path d="M6 2c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6H6z"/></svg>
                    {% endif %}
                    <span class="media-badge">{{ item.media_type }}</span>
                </div>
                <div class="media-body">
                    <div class="media-title" title="{{ item.title }}">{{ item.title }}</div>
                    <div class="media-meta">
                        <span>{{ item.file_size }}</span>
                        {% if item.dimensions %}<span>{{ item.dimensions }}</span>{% endif %}
                    </div>
                    <div class="media-actions">
                        <button class="btn btn-primary btn-sm" onclick="openEditModal({{ item.id }})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteMedia({{ item.id }})">Delete</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <svg width="80" height="80" fill="#CBD5E1" viewBox="0 0 24 24" style="margin-bottom: 16px;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
                <h3 style="margin-bottom: 8px;">No media files found</h3>
                <p>Upload your first file to get started</p>
            </div>
        {% endif %}
    </div>

    {% if paginator.num_pages > 1 %}
    <div class="pagination">
        {% if page_obj.has_previous %}
            <button class="page-link" onclick="goToPage(1)">First</button>
            <button class="page-link" onclick="goToPage({{ page_obj.previous_page_number }})">Prev</button>
        {% else %}
            <button class="page-link" disabled>First</button>
            <button class="page-link" disabled>Prev</button>
        {% endif %}

        <span class="page-link active">{{ page_obj.number }} / {{ paginator.num_pages }}</span>

        {% if page_obj.has_next %}
            <button class="page-link" onclick="goToPage({{ page_obj.next_page_number }})">Next</button>
            <button class="page-link" onclick="goToPage({{ paginator.num_pages }})">Last</button>
        {% else %}
            <button class="page-link" disabled>Next</button>
            <button class="page-link" disabled>Last</button>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h2>Upload Media</h2>
            <button class="modal-close" onclick="closeUploadModal()">&times;</button>
        </div>
        <form id="uploadForm">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-group">
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <p style="font-weight: 500; margin-bottom: 8px;">Click to upload or drag and drop</p>
                        <p style="font-size: 13px; color: var(--text-light);">Max file size: 10MB</p>
                        <input type="file" id="fileInput" name="file" style="display: none;">
                    </div>
                    <div id="fileName" style="margin-top: 8px; font-size: 14px; color: var(--primary);"></div>
                </div>

                <div class="form-group">
                    <label>Title</label>
                    <input type="text" name="title" class="form-control">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" class="form-control"></textarea>
                </div>

                <div class="form-group">
                    <label>Alt Text</label>
                    <input type="text" name="alt_text" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Upload</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h2>Edit Media</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="editForm">
            {% csrf_token %}
            <input type="hidden" id="editMediaId">
            <div class="modal-body">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="editTitle" name="title" class="form-control">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editDescription" name="description" class="form-control"></textarea>
                </div>

                <div class="form-group">
                    <label>Alt Text</label>
                    <input type="text" id="editAltText" name="alt_text" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Filter tabs
    document.querySelectorAll('.filter-tab').forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            const url = new URL(window.location.href);
            if (type) {
                url.searchParams.set('type', type);
            } else {
                url.searchParams.delete('type');
            }
            url.searchParams.delete('page');
            window.location.href = url.toString();
        });
    });

    // Search
    function applyFilters() {
        const searchValue = document.getElementById('searchInput').value.trim();
        const url = new URL(window.location.href);
        if (searchValue) {
            url.searchParams.set('search', searchValue);
        } else {
            url.searchParams.delete('search');
        }
        url.searchParams.delete('page');
        window.location.href = url.toString();
    }

    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyFilters();
        }
    });

    // Pagination
    function goToPage(page) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', page);
        window.location.href = url.toString();
    }

    // Upload Modal
    function openUploadModal() {
        document.getElementById('uploadModal').classList.add('show');
    }

    function closeUploadModal() {
        document.getElementById('uploadModal').classList.remove('show');
        document.getElementById('uploadForm').reset();
        document.getElementById('fileName').textContent = '';
    }

    // File input change event
    document.getElementById('fileInput').addEventListener('change', function() {
        if (this.files.length > 0) {
            document.getElementById('fileName').textContent = 'Selected: ' + this.files[0].name;
        }
    });

    // Drag and Drop functionality
    const uploadArea = document.querySelector('.upload-area');
    const fileInput = document.getElementById('fileInput');

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        uploadArea.style.borderColor = 'var(--primary)';
        uploadArea.style.background = '#E0F2F1';
    }

    function unhighlight(e) {
        uploadArea.style.borderColor = 'var(--border)';
        uploadArea.style.background = 'var(--bg-gray)';
    }

    // Handle dropped files
    uploadArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            // Create a new DataTransfer object
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(files[0]);
            fileInput.files = dataTransfer.files;
            
            // Update file name display
            document.getElementById('fileName').textContent = 'Selected: ' + files[0].name;
        }
    }

    // Upload form submission
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a file to upload');
            return;
        }

        // Validate file size (10MB)
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('File size exceeds 10MB limit');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('title', document.querySelector('#uploadForm [name="title"]').value);
        formData.append('description', document.querySelector('#uploadForm [name="description"]').value);
        formData.append('alt_text', document.querySelector('#uploadForm [name="alt_text"]').value);
        
        const csrftoken = getCookie('csrftoken');
        
        // Show loading state (optional)
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Uploading...';
        submitBtn.disabled = true;
        
        fetch('{% url "media_upload" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            
            if (data.success) {
                alert('Upload successful!');
                closeUploadModal();
                window.location.reload();
            } else {
                alert('Upload failed: ' + data.message);
            }
        })
        .catch(error => {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            console.error('Upload error:', error);
            alert('Error uploading file: ' + error);
        });
    });

    // Edit Modal
    function openEditModal(mediaId) {
        const csrftoken = getCookie('csrftoken');
        
        fetch('/admin/media/' + mediaId + '/get/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrftoken,
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP error! status: ' + response.status);
            }
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server returned non-JSON response. Please check your URL configuration.');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                document.getElementById('editMediaId').value = data.data.id;
                document.getElementById('editTitle').value = data.data.title || '';
                document.getElementById('editDescription').value = data.data.description || '';
                document.getElementById('editAltText').value = data.data.alt_text || '';
                document.getElementById('editModal').classList.add('show');
            } else {
                alert('Failed to load media: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Edit modal error:', error);
            alert('Error loading media: ' + error.message);
        });
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('show');
        document.getElementById('editForm').reset();
    }

    // Edit form submission
    document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const mediaId = document.getElementById('editMediaId').value;
        const formData = new FormData();
        formData.append('title', document.getElementById('editTitle').value);
        formData.append('description', document.getElementById('editDescription').value);
        formData.append('alt_text', document.getElementById('editAltText').value);
        
        const csrftoken = getCookie('csrftoken');
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Saving...';
        submitBtn.disabled = true;
        
        fetch('/admin/media/' + mediaId + '/update/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            
            if (data.success) {
                alert('Updated successfully!');
                closeEditModal();
                window.location.reload();
            } else {
                alert('Update failed: ' + data.message);
            }
        })
        .catch(error => {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            console.error('Update error:', error);
            alert('Error updating media: ' + error);
        });
    });

    // Delete function
    function deleteMedia(mediaId) {
        if (!confirm('Are you sure you want to delete this media? This action cannot be undone.')) {
            return;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        fetch('/admin/media/' + mediaId + '/delete/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Deleted successfully!');
                window.location.reload();
            } else {
                alert('Delete failed: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            alert('Error deleting media: ' + error);
        });
    }

    // Close modals on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeUploadModal();
            closeEditModal();
        }
    });

    // Close modals when clicking outside
    document.getElementById('uploadModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeUploadModal();
        }
    });

    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });
</script>

{% endblock %}