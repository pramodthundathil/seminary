{% extends "site_pages/index.html" %}

{% block content %}
<style>
    /* === Container & Layout === */
    .application-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
    }

    /* === Header === */
    .application-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .application-header h1 {
        color: var(--dark-navy);
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
    }

    .info-text {
        color: var(--text-gray);
        font-size: 1.1rem;
    }

    .required {
        color: #ef4444;
        margin-left: 2px;
    }

    /* === Progress Tracker === */
    .progress-tracker {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        padding: 0 20px;
        position: relative;
    }

    .progress-tracker::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 3px;
        background: #e5e7eb;
        z-index: 0;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 1;
        background: white;
        padding: 0 10px;
    }

    .progress-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #9ca3af;
        margin-bottom: 8px;
        transition: all 0.3s;
    }

    .progress-step.active .progress-circle {
        background: var(--primary-cyan);
        color: white;
    }

    .progress-step.completed .progress-circle {
        background: #10b981;
        color: white;
    }

    .progress-label {
        font-size: 0.85rem;
        color: var(--text-gray);
        text-align: center;
    }

    /* === Form Section === */
    .form-section {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--primary-cyan);
    }

    .section-header i {
        font-size: 1.5rem;
        color: var(--primary-cyan);
    }

    .section-header h3 {
        color: var(--dark-navy);
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }

    /* === Form Fields === */
    .form-row-modern {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-field {
        display: flex;
        flex-direction: column;
    }

    .form-field.full-width {
        grid-column: 1 / -1;
    }

    .form-field label {
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
        width: 100%;
        padding: 12px 16px;
        font-size: 15px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        outline: none;
        transition: all 0.2s;
        color: #374151;
    }

    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
        border-color: var(--primary-cyan);
        box-shadow: 0 0 0 3px rgba(0, 206, 209, 0.1);
    }

    .form-field input.input-error,
    .form-field select.input-error {
        border-color: #ef4444;
        background: #fef2f2;
    }

    .form-field input.input-valid {
        border-color: #10b981;
    }

    .form-field textarea {
        min-height: 120px;
        resize: vertical;
    }

    .error-message {
        color: #ef4444;
        font-size: 0.85rem;
        margin-top: 5px;
        display: none;
    }

    .character-count {
        color: #666;
        font-size: 0.85rem;
        margin-top: 5px;
        text-align: right;
    }

    /* === reCAPTCHA Box === */
    .verification-section {
        background: #f9fafb;
    }

    .recaptcha-box {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background: white;
    }

    .recaptcha-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .recaptcha-left input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .recaptcha-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        font-size: 0.75rem;
        color: #666;
    }

    .recaptcha-title {
        font-weight: 600;
        color: #374151;
    }

    /* === Buttons === */
    .btn-group {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
    }

    .btn-primary,
    .btn-secondary {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--purple-gradient-start), var(--purple-gradient-end));
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(167, 139, 250, 0.4);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }
    /* === Loading Overlay === */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner-border {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-cyan);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* === Responsive === */
    @media (max-width: 768px) {
        .form-row-modern {
            grid-template-columns: 1fr;
        }

        .progress-tracker {
            padding: 0 10px;
            font-size: 0.75rem;
        }

        .application-header h1 {
            font-size: 2rem;
        }

        .form-section {
            padding: 20px;
        }

        .btn-group {
            flex-direction: column;
        }

        .btn-primary,
        .btn-secondary {
            width: 100%;
            justify-content: center;
        }
    }
</style>

<div class="application-container">
    <form id="referenceForm" class="reference-form" method="POST" action="" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="application-header">
            <h1>Reference Submission</h1>
            <p class="info-text">Use this form to submit a reference for an applicant. Fields marked with <span
                    class="required">*</span> are required.</p>
        </div>
        <div class="progress-tracker">
            <div class="progress-step active">
                <div class="progress-circle">1</div>
                <span class="progress-label">Referee Info</span>
            </div>
            <div class="progress-step">
                <div class="progress-circle">2</div>
                <span class="progress-label">Applicant Info</span>
            </div>
            <div class="progress-step">
                <div class="progress-circle">3</div>
                <span class="progress-label">Assessment</span>
            </div>
            <div class="progress-step">
                <div class="progress-circle">4</div>
                <span class="progress-label">Comments</span>
            </div>
            <div class="progress-step">
                <div class="progress-circle">5</div>
                <span class="progress-label">Verify</span>
            </div>
        </div>
        <!-- Referee Information -->
        <div class="form-section">
            <div class="section-header">
                <i class="fas fa-user-tie"></i>
                <h3>Referee Information</h3>
            </div>
            <div class="form-row-modern">
                <div class="form-field">
                    <label for="first_name">First Name <span class="required">*</span></label>
                    <input type="text" id="first_name" name="first_name" placeholder="Enter your first name" required>
                    <small class="error-message" id="first_name_error"></small>
                </div>
                <div class="form-field">
                    <label for="middle_name">Middle Name</label>
                    <input type="text" id="middle_name" name="middle_name" placeholder="Optional">
                </div>
            </div>
            <div class="form-row-modern">
                <div class="form-field">
                    <label for="last_name">Last Name <span class="required">*</span></label>
                    <input type="text" id="last_name" name="last_name" placeholder="Enter your last name" required>
                    <small class="error-message" id="last_name_error"></small>
                </div>
                <div class="form-field">
                    <label for="email">Email <span class="required">*</span></label>
                    <input type="email" id="email" name="email" placeholder="your.email@example.com" required>
                    <small id="email_error" class="error-message"></small>
                </div>
            </div>
            <div class="form-row-modern">
                <div class="form-field">
                    <label for="contact">Contact Number <span class="required">*</span></label>
                    <input type="tel" id="contact" name="contact" placeholder="(555) 123-4567" required>
                    <small id="contact_error" class="error-message"></small>
                </div>
                <div class="form-field">
                    <label for="nationality">Nationality <span class="required">*</span></label>
                    <select id="nationality" name="nationality" required>
                        <option value="">Select Country</option>
                        {% for country in countries %}
                        <option value="{{ country.id }}">{{ country.name }}</option>
                        {% endfor %}
                    </select>
                    <small class="error-message" id="nationality_error"></small>
                </div>
            </div>
        </div>

        <!-- Applicant Information -->
        <div class="form-section">
            <div class="section-header">
                <i class="fas fa-id-card"></i>
                <h3>Applicant Information</h3>
            </div>
            <div class="form-row-modern">
                <div class="form-field">
                    <label for="applicant_name">Name of Applicant <span class="required">*</span></label>
                    <input type="text" id="applicant_name" name="applicant_name"
                        placeholder="Full name of the applicant" required>
                    <small class="error-message" id="applicant_name_error"></small>
                </div>
                <div class="form-field">
                    <label for="relationship">Your Relationship with the Applicant</label>
                    <select id="relationship" name="relationship" required>
                        <option value="">--- Select ---</option>
                        <option value="pastor">Pastor</option>
                        <option value="teacher">Teacher/Professor</option>
                        <option value="employer">Employer</option>
                        <option value="colleague">Colleague</option>
                        <option value="friend">Friend</option>
                        <option value="relative">Relative</option>
                        <option value="mentor">Mentor</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-row-modern">
                <div class="form-field">
                    <label for="known_since">Since when you know this Applicant</label>
                    <input type="text" id="known_since" name="known_since" placeholder="e.g., January 2020 or 5 years"
                        required>
                </div>
            </div>
        </div>

        <!-- Applicant Assessment -->
        <div class="form-section">
            <div class="section-header">
                <i class="fas fa-clipboard-check"></i>
                <h3>Applicant Assessment</h3>
            </div>

            <div class="form-row-modern">
                <div class="form-field">
                    <label for="spiritual_commitment">Spiritual Commitment <span class="required">*</span></label>
                    <select id="spiritual_commitment" name="spiritual_commitment" required>
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                    <small class="error-message" id="spiritual_commitment_error"></small>
                </div>
                <div class="form-field">
                    <label for="learning_capacity">Learning Capacity</label>
                    <select id="learning_capacity" name="learning_capacity">
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                </div>
            </div>

            <div class="form-row-modern">
                <div class="form-field">
                    <label for="dedication">Dedication for Lord's Ministry</label>
                    <select id="dedication" name="dedication">
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="leadership">Leadership Skills</label>
                    <select id="leadership" name="leadership">
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                </div>
            </div>

            <div class="form-row-modern">
                <div class="form-field">
                    <label for="church_involvement">Church Involvement</label>
                    <select id="church_involvement" name="church_involvement">
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="biblical_knowledge">Biblical Knowledge <span class="required">*</span></label>
                    <select id="biblical_knowledge" name="biblical_knowledge" required>
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                    <small class="error-message" id="biblical_knowledge_error"></small>
                </div>
            </div>

            <div class="form-row-modern">
                <div class="form-field">
                    <label for="moral_standard">Moral Standard</label>
                    <select id="moral_standard" name="moral_standard">
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="recommendation">Recommendation</label>
                    <select id="recommendation" name="recommendation">
                        <option value="">--- Select ---</option>
                        <option value="highly_recommend">Highly Recommend</option>
                        <option value="recommend">Recommend</option>
                        <option value="recommend_with_reservation">Recommend with Reservation</option>
                        <option value="do_not_recommend">Do Not Recommend</option>
                    </select>
                </div>
            </div>

            <div class="form-row-modern">
                <div class="form-field">
                    <label for="financial_condition">Financial Condition</label>
                    <select id="financial_condition" name="financial_condition">
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Additional Comments -->
        <div class="form-section">
            <div class="section-header">
                <i class="fas fa-comments"></i>
                <h3>Additional Comments</h3>
            </div>
            <div class="form-field full-width">
                <label for="comments">Personal Comment for this Applicant</label>
                <textarea id="comments" name="comments" rows="6" maxlength="1000"
                    placeholder="Additional insights about the applicant"></textarea>
                <small class="character-count">0 / 1000 characters</small>
            </div>
        </div>

        <!-- reCAPTCHA & Verification -->
        <div class="form-section verification-section">
            <div class="recaptcha-box">
                <div class="recaptcha-left">
                    <input type="checkbox" id="notRobot" required>
                    <label for="notRobot">I'm not a robot</label>
                </div>
                <div class="recaptcha-right">
                    <span class="recaptcha-title">reCAPTCHA</span>
                    <span class="recaptcha-links">Privacy – Terms</span>
                </div>
            </div>
            <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                This Reference Form will be strictly confidential and will not be shown to Applicant or any other
                person.
                By clicking "Submit", you agree that the information given is true to your knowledge.
            </p>
        </div>

        <!-- Submit & Cancel -->
         <div class="btn-group">
            <button type="button" class="btn-secondary" onclick="window.history.back()">Cancel</button>
            <button type="submit" class="btn-primary" id="submitBtn">Submit Application</button>
        </div>
    </form>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('referenceForm');
        const cancelBtn = document.getElementById('cancelBtn');
        const submitBtn = document.getElementById('submitBtn');
        const commentsTextarea = document.getElementById('comments');
        const charCount = document.querySelector('.character-count');

        const requiredFields = [
            'first_name', 'last_name', 'email', 'nationality',
            'applicant_name', 'contact',
            'spiritual_commitment', 'biblical_knowledge'
        ];

        const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        const touchedFields = {};

        // Cancel button
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function () {
                form.reset();
                if (charCount) charCount.textContent = '0 / 1000 characters';
                form.querySelectorAll('.input-error').forEach(f => f.classList.remove('input-error'));
                form.querySelectorAll('.error-message').forEach(e => { e.textContent = ''; e.style.display = 'none'; });
            });
        }

        // Character counter
        if (commentsTextarea && charCount) {
            commentsTextarea.addEventListener('input', function () {
                const count = this.value.length;
                charCount.textContent = `${count} / 1000 characters`;
                charCount.style.color = count > 900 ? '#dc3545' : '#666';
            });
        }

        // Track touched fields
        requiredFields.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('input', () => {
                touchedFields[id] = true;
                validateField(id);
                validateForm();
            });
            el.addEventListener('blur', () => {
                touchedFields[id] = true;
                validateField(id);
            });
        });

        function showError(el, box, message) {
            el.classList.add('input-error');
            el.classList.remove('input-valid');
            if (box) {
                box.textContent = message;
                box.style.display = 'block';
            }
        }

        function clearError(el, box) {
            el.classList.remove('input-error');
            if (box) {
                box.textContent = '';
                box.style.display = 'none';
            }
        }

        function validateEmail(id) {
            const el = document.getElementById(id);
            const box = document.getElementById(id + '_error');
            if (!el) return true;
            const val = el.value.trim();
            if (!touchedFields[id]) { clearError(el, box); return false; }
            if (!val) { showError(el, box, 'This field is required'); return false; }
            if (!emailPattern.test(val)) { showError(el, box, 'Invalid email format'); return false; }
            clearError(el, box);
            el.classList.add('input-valid');
            return true;
        }

        function validatePhone(id) {
            const el = document.getElementById(id);
            const box = document.getElementById(id + '_error');
            if (!el) return true;
            const raw = el.value.trim();
            if (raw === '') { clearError(el, box); return true; }
            if (!touchedFields[id]) { clearError(el, box); return false; }
            const digits = raw.replace(/\D/g, '');
            if (digits !== raw) { showError(el, box, 'Only digits are allowed'); return false; }
            if (digits.length < 7 || digits.length > 15) { showError(el, box, 'Phone number must be 7–15 digits'); return false; }
            clearError(el, box);
            el.classList.add('input-valid');
            return true;
        }

        function validateField(id) {
            const el = document.getElementById(id);
            const box = document.getElementById(id + '_error');
            if (!el) return true;
            if (id === 'contact') return validatePhone(id);
            if (id === 'email') return validateEmail(id);

            const val = el.value.trim();
            if (!val && touchedFields[id]) {
                showError(el, box, 'This field is required');
                return false;
            }
            clearError(el, box);
            if (val) el.classList.add('input-valid');
            else el.classList.remove('input-valid');
            return true;
        }

        function validateForm() {
            let allValid = true;
            for (const id of requiredFields) {
                if (!validateField(id)) allValid = false;
            }
            if (submitBtn) submitBtn.disabled = !allValid;
            return allValid;
        }

        // Initial state
        if (submitBtn) submitBtn.disabled = true;

        // Form submit
        if (form) {
            form.addEventListener('submit', function (e) {
                requiredFields.forEach(id => touchedFields[id] = true);
                if (!validateForm()) {
                    e.preventDefault();
                    const firstError = document.querySelector('.input-error');
                    if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    alert('Please fill in all required fields correctly.');
                    return;
                }

                // reCAPTCHA check
                if (typeof grecaptcha !== 'undefined') {
                    const recaptchaResponse = grecaptcha.getResponse();
                    if (!recaptchaResponse) {
                        e.preventDefault();
                        alert('Please complete the reCAPTCHA verification.');
                        return;
                    }
                }

                // Show loading
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) overlay.classList.add('active');
                if (submitBtn) submitBtn.disabled = true;
            });
        }

        // Progress tracking on scroll
        window.addEventListener('scroll', function () {
            const sections = document.querySelectorAll('.form-section');
            const progressSteps = document.querySelectorAll('.progress-step');
            sections.forEach((section, index) => {
                const rect = section.getBoundingClientRect();
                if (rect.top < window.innerHeight / 2 && rect.bottom > 0) {
                    progressSteps.forEach((step, stepIndex) => {
                        if (stepIndex <= index) step.classList.add('active');
                        else step.classList.remove('active');
                    });
                }
            });
        });
    });
</script>

{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }}">{{ message }}</div>
{% endfor %}
{% endif %}

{% endblock %}