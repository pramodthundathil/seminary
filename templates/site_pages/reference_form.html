{% extends "site_pages/index.html" %}
{% load static %}

{% block title %}
<title>Reference Form - Trinity Theological Seminary</title>
{% endblock %}

{% block content %}
<section class="application-section-modern">
    <div class="form-container-modern">
        <div class="form-modal">
            <!-- Modal Header -->
            <div class="modal-header">
                <div class="header-content">
                    <i class="fas fa-user-graduate"></i>
                    <h2>Reference Form</h2>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
                {% endfor %}
                {% endif %}

                <form method="POST" action="" class="reference-form" novalidate>
                    {% csrf_token %}

                    <!-- Referee Information -->
                    <div class="form-section">
                        <div class="section-header">
                            <i class="fas fa-user-tie"></i>
                            <h3>Referee Information</h3>
                        </div>
                        <div class="form-row-modern">
                            <div class="form-field">
                                <label for="first_name">First Name <span class="required">*</span></label>
                                <input type="text" id="first_name" name="first_name" placeholder="Enter your first name"
                                    required>
                                <small class="error-message" id="first_name_error"></small>
                            </div>
                            <div class="form-field">
                                <label for="middle_name">Middle Name</label>
                                <input type="text" id="middle_name" name="middle_name" placeholder="Optional">
                                <small class="error-message"></small>
                            </div>
                        </div>
                        <div class="form-row-modern">
                            <div class="form-field">
                                <label for="last_name">Last Name <span class="required">*</span></label>
                                <input type="text" id="last_name" name="last_name" placeholder="Enter your last name"
                                    required>
                                <small class="error-message" id="last_name_error"></small>
                            </div>
                            <div class="form-field">
                                <label for="email">Email <span class="required">*</span></label>
                                <input type="email" id="email" name="email" placeholder="your.email@example.com"
                                    required>
                                    <small id="email_error" class="error-message"></small>                                
                            </div>
                        </div>
                        <div class="form-row-modern">
                            <div class="form-field">
                                <label for="contact">Contact Number <span class="required">*</span></label>
                                <input type="tel" id="contact" name="contact" placeholder="(555) 123-4567" required>
                                <small id="contact_error" class="error-message"></small>
                            </div>
                            <div class="form-field">
                                <label for="nationality">Nationality <span class="required">*</span></label>
                                <select id="nationality" name="nationality">
                                    <option value="">Select Country</option>
                                    {% for country in countries %}
                                    <option value="{{ country.id }}">{{ country.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="error-message" id="nationality_error"></small>
                            </div>
                        </div>
                    </div>

                    <!-- Applicant Information -->
                    <div class="form-section">
                        <div class="section-header">
                            <i class="fas fa-id-card"></i>
                            <h3>Applicant Information</h3>
                        </div>
                        <div class="form-row-modern">
                            <div class="form-field">
                                <label for="applicant_name">Name of Applicant <span class="required">*</span></label>
                                <input type="text" id="applicant_name" name="applicant_name"
                                    placeholder="Full name of the applicant" required>
                                <small class="error-message" id="applicant_name_error"></small>
                            </div>
                            <div class="form-field">
                                <label for="relationship">Your Relationship with the Applicant</label>
                                <select id="relationship" name="relationship" required>
                                    <option value="">--- Select ---</option>
                                    <option value="pastor">Pastor</option>
                                    <option value="teacher">Teacher/Professor</option>
                                    <option value="employer">Employer</option>
                                    <option value="colleague">Colleague</option>
                                    <option value="friend">Friend</option>
                                    <option value="relative">Relative</option>
                                    <option value="mentor">Mentor</option>
                                    <option value="other">Other</option>
                                </select>                               
                            </div>
                        </div>
                        <div class="form-row-modern">
                            <div class="form-field">
                                <label for="known_since">Since when you know this Applicant</label>
                                <input type="text" id="known_since" name="known_since"
                                    placeholder="e.g., January 2020 or 5 years" required>                                
                            </div>
                        </div>
                    </div>

                    <!-- Applicant Assessment -->
                    <div class="form-section">
                        <div class="section-header">
                            <i class="fas fa-clipboard-check"></i>
                            <h3>Applicant Assessment</h3>
                        </div>

                        <!-- Row 1 -->
                        <div class="form-row-modern">
                            <div class="form-field">
                                <label for="spiritual_commitment">How do you rate Applicant's Spiritual Commitment?
                                    <span class="required">*</span></label>
                                <select id="spiritual_commitment" name="spiritual_commitment" required>
                                    <option value="">--- Select ---</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="very_good">Very Good</option>
                                    <option value="good">Good</option>
                                    <option value="average">Average</option>
                                    <option value="below_average">Below Average</option>
                                </select>
                                <small class="error-message" id="spiritual_commitment_error"></small>
                            </div>

                            <div class="form-field">
                                <label for="learning_capacity">How do you rate Applicant's Learning Capacity?</label>
                                <select id="learning_capacity" name="learning_capacity">
                                    <option value="">--- Select ---</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="very_good">Very Good</option>
                                    <option value="good">Good</option>
                                    <option value="average">Average</option>
                                    <option value="below_average">Below Average</option>
                                </select>                                
                            </div>
                        </div>

                        <!-- Row 2 -->
                        <div class="form-row-modern">
                            <div class="form-field">
                                <label for="dedication">What do think about Applicant's Dedication for Lord's
                                    Ministry?</label>
                                <select id="dedication" name="dedication">
                                    <option value="">--- Select ---</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="very_good">Very Good</option>
                                    <option value="good">Good</option>
                                    <option value="average">Average</option>
                                    <option value="below_average">Below Average</option>
                                </select>
                            </div>

                            <div class="form-field">
                                <label for="leadership">How do you rate Applicant's Leadership skills?</label>
                                <select id="leadership" name="leadership">
                                    <option value="">--- Select ---</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="very_good">Very Good</option>
                                    <option value="good">Good</option>
                                    <option value="average">Average</option>
                                    <option value="below_average">Below Average</option>
                                </select>
                            </div>
                        </div>

                        <!-- Row 3 -->
                        <div class="form-row-modern">
                            <div class="form-field">
                                <label for="church_involvement">How do you rate Applicant's Church involvement?</label>
                                <select id="church_involvement" name="church_involvement">
                                    <option value="">--- Select ---</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="very_good">Very Good</option>
                                    <option value="good">Good</option>
                                    <option value="average">Average</option>
                                    <option value="below_average">Below Average</option>
                                </select>
                            </div>

                            <div class="form-field">
                                <label for="biblical_knowledge">What do you think about Applicant's Biblical Knowledge?
                                    <span class="required">*</span></label>
                                <select id="biblical_knowledge" name="biblical_knowledge" required>
                                    <option value="">--- Select ---</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="very_good">Very Good</option>
                                    <option value="good">Good</option>
                                    <option value="average">Average</option>
                                    <option value="below_average">Below Average</option>
                                </select>
                                <span class="error-msg" id="biblical_knowledge_error"></span>
                            </div>
                        </div>

                        <!-- Row 4 -->
                        <div class="form-row-modern">
                            <div class="form-field">
                                <label for="moral_standard">How do you rate Applicant's Moral Standard?</label>
                                <select id="moral_standard" name="moral_standard">
                                    <option value="">--- Select ---</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="very_good">Very Good</option>
                                    <option value="good">Good</option>
                                    <option value="average">Average</option>
                                    <option value="below_average">Below Average</option>
                                </select>
                            </div>

                            <div class="form-field">
                                <label for="recommendation">How do you recommend this Applicant</label>
                                <select id="recommendation" name="recommendation">
                                    <option value="">--- Select ---</option>
                                    <option value="highly_recommend">Highly Recommend</option>
                                    <option value="recommend">Recommend</option>
                                    <option value="recommend_with_reservation">Recommend with Reservation</option>
                                    <option value="do_not_recommend">Do Not Recommend</option>
                                </select>
                            </div>
                        </div>

                        <!-- Row 5 -->
                        <div class="form-row-modern">
                            <div class="form-field">
                                <label for="financial_condition">What do you think about Financial Condition of the
                                    Applicant</label>
                                <select id="financial_condition" name="financial_condition">
                                    <option value="">--- Select ---</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="very_good">Very Good</option>
                                    <option value="good">Good</option>
                                    <option value="average">Average</option>
                                    <option value="below_average">Below Average</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Comments -->
                    <div class="form-section">
                        <div class="section-header">
                            <i class="fas fa-comments"></i>
                            <h3>Additional Comments</h3>
                        </div>
                        <div class="form-field full-width">
                            <label for="comments">Write your personal comment for this Applicant.</label>
                            <textarea id="comments" name="comments" rows="6" maxlength="1000"
                                placeholder="Additional insights about the applicant"></textarea>
                            <small class="character-count">0 / 1000 characters</small>
                        </div>
                    </div>

                    <!-- reCAPTCHA -->
                    <div class="form-section verification-section">
                        <div class="recaptcha-box">
                            <div class="recaptcha-left">
                                <input type="checkbox" id="notRobot" required>
                                <label for="notRobot">I'm not a robot</label>
                            </div>
                            <div class="recaptcha-right">
                                <span class="recaptcha-title">reCAPTCHA</span>
                                <span class="recaptcha-links">Privacy – Terms</span>
                            </div>
                        </div>
                        <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                            This Reference Form will be strictly confidential and will not be shown to Applicant or any
                            other person at any cause.
                            By clicking "Submit", you agree to stay with your sincere statement that all the information
                            given is true to your knowledge and is reliable.
                        </p>
                    </div>

                    <!-- Submit & Cancel -->
                    <div class="form-actions">
                        <button type="button" class="btn-cancel">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn-save">
                            <i class="fas fa-paper-plane"></i> Submit
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</section>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('.reference-form');
        const cancelBtn = form.querySelector('.btn-cancel');
        const submitBtn = form.querySelector('.btn-save');
        const commentsTextarea = document.getElementById('comments');
        const charCount = document.querySelector('.character-count');
        // ======= Required fields =======
        const requiredFields = [
            'first_name', 'last_name', 'email', 'nationality',
            'applicant_name', 'contact',
            'spiritual_commitment', 'biblical_knowledge'
        ];

        const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        // Cancel button resets form
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function () {
                form.reset();

                if (charCount) charCount.textContent = '0 / 500 characters';

                form.querySelectorAll('.input-error').forEach(f => f.classList.remove('input-error'));
                form.querySelectorAll('.error-message').forEach(e => e.textContent = '');
            });
        }
        // Character counter for comments
        if (commentsTextarea && charCount) {
            commentsTextarea.addEventListener('input', function () {
                const count = this.value.length;
                charCount.textContent = `${count} / 1000 characters`;
                charCount.style.color = count > 900 ? '#dc3545' : '#666';
            });
        }

        // Touched fields tracking
        const touchedFields = {};

        // Add event listeners for validation
        requiredFields.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;

            el.addEventListener('input', () => {
                touchedFields[id] = true;
                validateField(id);
                validateForm();
            });

            el.addEventListener('blur', () => {
                touchedFields[id] = true;
                validateField(id);
            });
        });

        // Validation functions
        function validateEmail(id) {
            const el = document.getElementById(id);
            const errorBox = document.getElementById(id + '_error');
            if (!el || !errorBox) return true;

            const val = el.value.trim();

            if (!touchedFields[id]) {
                clearError(el, errorBox);
                return false;
            }

            if (!val) {
                showError(el, errorBox, 'This field is required');
                return false;
            }
            if (!emailPattern.test(val)) {
                showError(el, errorBox, 'Invalid email format');
                return false;
            }

            clearError(el, errorBox);
            return true;
        }

        function validatePhone(id) {
            const el = document.getElementById(id);
            const errorBox = document.getElementById(id + '_error');
            if (!el || !errorBox) return true;

            const raw = el.value.trim();

            // Optional field → allow empty
            if (raw === "") {
                clearError(el, errorBox);
                return true;
            }

            // Validate only after touched
            if (!touchedFields[id]) {
                clearError(el, errorBox);
                return false;
            }

            // Must contain digits only
            const digits = raw.replace(/\D/g, '');
            if (digits !== raw) {
                showError(el, errorBox, 'Only digits are allowed');
                return false;
            }

            // Length 7–15 digits
            if (digits.length < 7 || digits.length > 15) {
                showError(el, errorBox, 'Phone number must be 7–15 digits');
                return false;
            }

            clearError(el, errorBox);
            return true;
        }

        function validateField(id) {
            const el = document.getElementById(id);
            const errorBox = document.getElementById(id + '_error');
            if (!el || !errorBox) return true;

            // SPECIAL HANDLING — skip contact here
            if (id === 'contact') {
                return validatePhone(id);
            }

            const val = el.value.trim();
            let error = '';

            if (!val) error = 'This field is required';

            if (!error && id === 'email' && val && !emailPattern.test(val)) {
                error = 'Invalid email format';
            }

            if (error && touchedFields[id]) {
                showError(el, errorBox, error);
                return false;
            } else {
                clearError(el, errorBox);
                if (val) el.classList.add('input-valid');
                else el.classList.remove('input-valid');
                return error === '';
            }
        }
        function showError(el, box, message) {
            el.classList.add('input-error');
            el.classList.remove('input-valid');
            box.textContent = message;
            box.style.display = 'block';
        }

        function clearError(el, box) {
            el.classList.remove('input-error');
            box.textContent = '';
            box.style.display = 'none';
        }

        function validateForm() {
            let allValid = true;

            for (const id of requiredFields) {
                if (id === 'email') {
                    if (!validateEmail(id)) allValid = false;
                } else if (id === 'contact') {
                    if (!validatePhone(id)) allValid = false;
                } else {
                    if (!validateField(id)) allValid = false;
                }
            }

            if (submitBtn) submitBtn.disabled = !allValid;
            return allValid;
        }

        // Initial state
        submitBtn.disabled = true;

        // Form submission
        if (form) {
            form.addEventListener('submit', function (e) {
                requiredFields.forEach(id => touchedFields[id] = true);

                if (!validateForm()) {
                    e.preventDefault();
                    const firstError = document.querySelector('.input-error');
                    if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    alert('Please fill in all required fields correctly.');
                    return;
                }

                // reCAPTCHA check
                if (typeof grecaptcha !== 'undefined') {
                    const recaptchaResponse = grecaptcha.getResponse();
                    if (!recaptchaResponse) {
                        e.preventDefault();
                        alert('Please complete the reCAPTCHA verification.');
                        return;
                    }
                }
            });
        }
    });
</script>
{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }}">
    {{ message }}
</div>
{% endfor %}
{% endif %}
{% endblock %}