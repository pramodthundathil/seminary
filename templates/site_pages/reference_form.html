{% extends "site_pages/index.html" %}

{% block title %}
<title>Reference Form - Trinity Theological Seminary</title>
{% endblock %}

{% block content %}
<section class="reference-section">
    <div class="container">
        <h2 class="section-title">Reference <span class="highlight">Form</span></h2>

        <!-- Intro -->
        <div class="intro-section">
            <p>
                Please complete the following reference form to help us evaluate the applicant’s suitability for study
                at Trinity Theological Seminary. All information will remain confidential. Required fields are marked
                with <span class='required'>*</span>.
            </p>
        </div>

        <!-- Form Wrapper -->
        <div class="reference-form-wrapper">
            <form method="POST" action="" class="reference-form" novalidate>
                {% csrf_token %}

                <!-- Referee Information -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-user"></i> REFEREE INFORMATION
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="first_name">First Name <span class="required">*</span></label>
                            <input type="text" id="first_name" name="first_name" placeholder="Enter your first name"
                                required>
                            <span class="error-msg" id="first_name_error"></span>
                        </div>
                        <div class="form-group">
                            <label for="middle_name">Middle Name</label>
                            <input type="text" id="middle_name" name="middle_name" placeholder="Optional">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="last_name">Last Name <span class="required">*</span></label>
                            <input type="text" id="last_name" name="last_name" placeholder="Enter your last name"
                                required>
                            <span class="error-msg" id="last_name_error"></span>
                        </div>
                        <div class="form-group">
                            <label for="email">Email <span class="required">*</span></label>
                            <input type="email" id="email" name="email" placeholder="your.email@example.com" required>
                            <span class="error-msg" id="email_error"></span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contact">Contact Number<span class="required">*</span></label>
                            <input type="tel" id="contact" name="contact" placeholder="(555) 123-4567" required>
                            <span class="error-msg" id="contact_error"></span>
                        </div>
                        <div class="form-group">
                            <label for="nationality">Nationality <span class="required">*</span></label>
                            <select id="nationality" name="nationality" required>
                                <option value="">--- Select Country ---</option>
                            </select>
                            <span class="error-msg" id="nationality_error"></span>
                        </div>
                    </div>
                </div>

                <!-- Applicant Information -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-user-graduate"></i> APPLICANT INFORMATION
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="applicant_name">Name of Applicant <span class="required">*</span></label>
                            <input type="text" id="applicant_name" name="applicant_name"
                                placeholder="Full name of the applicant" required>
                            <span class="error-msg" id="applicant_name_error"></span>
                        </div>
                        <div class="form-group">
                            <label for="relationship">Your Relationship with the Applicant
                                ></label>
                            <select id="relationship" name="relationship" required>
                                <option value="">--- Select ---</option>
                                <option value="pastor">Pastor</option>
                                <option value="teacher">Teacher/Professor</option>
                                <option value="employer">Employer</option>
                                <option value="colleague">Colleague</option>
                                <option value="friend">Friend</option>
                                <option value="relative">Relative</option>
                                <option value="mentor">Mentor</option>
                                <option value="other">Other</option>
                            </select>
                            <span class="error-msg" id="relationship_error"></span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="known_since">Since when you know this Applicant</label>
                            <input type="text" id="known_since" name="known_since"
                                placeholder="e.g., January 2020 or 5 years" required>
                            <span class="error-msg" id="known_since_error"></span>
                        </div>
                    </div>
                </div>

                <!-- Assessment Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-clipboard-check"></i> APPLICANT ASSESSMENT
                    </div>

                    <!-- Row 1 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="spiritual_commitment">How do you rate Applicant's Spiritual Commitment? <span
                                    class="required">*</span></label>
                            <select id="spiritual_commitment" name="spiritual_commitment" required>
                                <option value="">--- Select ---</option>
                                <option value="excellent">Excellent</option>
                                <option value="very_good">Very Good</option>
                                <option value="good">Good</option>
                                <option value="average">Average</option>
                                <option value="below_average">Below Average</option>
                            </select>
                            <span class="error-msg" id="spiritual_commitment_error"></span>
                        </div>
                        <div class="form-group">
                            <label for="learning_capacity">How do you rate Applicant's Learning Capacity?</label>
                            <select id="learning_capacity" name="learning_capacity">
                                <option value="">--- Select ---</option>
                                <option value="excellent">Excellent</option>
                                <option value="very_good">Very Good</option>
                                <option value="good">Good</option>
                                <option value="average">Average</option>
                                <option value="below_average">Below Average</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dedication">What do think about Applicant's Dedication for Lord's
                                Ministry?</label>
                            <select id="dedication" name="dedication">
                                <option value="">--- Select ---</option>
                                <option value="excellent">Excellent</option>
                                <option value="very_good">Very Good</option>
                                <option value="good">Good</option>
                                <option value="average">Average</option>
                                <option value="below_average">Below Average</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leadership">How do you rate Applicant's Leadership skills?</label>
                            <select id="leadership" name="leadership">
                                <option value="">--- Select ---</option>
                                <option value="excellent">Excellent</option>
                                <option value="very_good">Very Good</option>
                                <option value="good">Good</option>
                                <option value="average">Average</option>
                                <option value="below_average">Below Average</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 3 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="church_involvement">How do you rate Applicant's Church involvement?</label>
                            <select id="church_involvement" name="church_involvement">
                                <option value="">--- Select ---</option>
                                <option value="excellent">Excellent</option>
                                <option value="very_good">Very Good</option>
                                <option value="good">Good</option>
                                <option value="average">Average</option>
                                <option value="below_average">Below Average</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="biblical_knowledge">What do you think about Applicant's Biblical Knowledge?
                                <span class="required">*</span></label>
                            <select id="biblical_knowledge" name="biblical_knowledge" required>
                                <option value="">--- Select ---</option>
                                <option value="excellent">Excellent</option>
                                <option value="very_good">Very Good</option>
                                <option value="good">Good</option>
                                <option value="average">Average</option>
                                <option value="below_average">Below Average</option>
                            </select>
                            <span class="error-msg" id="biblical_knowledge_error"></span>
                        </div>
                    </div>

                    <!-- Row 4 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="moral_standard">How do you rate Applicant's Moral Standard?</label>
                            <select id="moral_standard" name="moral_standard">
                                <option value="">--- Select ---</option>
                                <option value="excellent">Excellent</option>
                                <option value="very_good">Very Good</option>
                                <option value="good">Good</option>
                                <option value="average">Average</option>
                                <option value="below_average">Below Average</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="recommendation">How do you recommend this Applicant</label>
                            <select id="recommendation" name="recommendation">
                                <option value="">--- Select ---</option>
                                <option value="highly_recommend">Highly Recommend</option>
                                <option value="recommend">Recommend</option>
                                <option value="recommend_with_reservation">Recommend with Reservation</option>
                                <option value="do_not_recommend">Do Not Recommend</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 5 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="financial_condition">What do you think about Financial Condition of the
                                Applicant</label>
                            <select id="financial_condition" name="financial_condition">
                                <option value="">--- Select ---</option>
                                <option value="excellent">Excellent</option>
                                <option value="very_good">Very Good</option>
                                <option value="good">Good</option>
                                <option value="average">Average</option>
                                <option value="below_average">Below Average</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Additional Comments -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-comments"></i> ADDITIONAL COMMENTS
                    </div>
                    <div class="form-group full-width">
                        <label for="comments">Write your personal comment for this Applicant.</label>
                        <textarea id="comments" name="comments" rows="6" maxlength="1000"
                            placeholder="Additional insights about the applicant"></textarea>
                        <small class="character-count">0 / 1000 characters</small>
                    </div>
                </div>

                <!-- reCAPTCHA -->
                <div class="form-section verification-section">
                    <div class="recaptcha-box">
                        <div class="recaptcha-left">
                            <input type="checkbox" id="notRobot" required>
                            <label for="notRobot">I'm not a robot</label>
                        </div>

                        <div class="recaptcha-right">
                            <span class="recaptcha-title">reCAPTCHA</span>
                            <span class="recaptcha-links">Privacy – Terms</span>
                        </div>
                    </div>
                    <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                        This Reference Form will be strictly confidential and will not be shown to Applicant or any
                        other person at any cause.
                        By clicking "Submit", you agree to stay with your sincere statement that all the information
                        given is true to your knowledge and is reliable.
                    </p>
                </div>

                <!-- Submit -->
                <div class="form-submit">
                    <button type="submit" class="btn-submit" id="submitBtn">
                        SUBMIT
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('.reference-form');
        const submitBtn = document.getElementById('submitBtn');
        const commentsTextarea = document.getElementById('comments');
        const charCount = document.querySelector('.character-count');

        // ======= Required fields =======
        const requiredFields = [
            'first_name', 'last_name', 'email', 'nationality',
            'applicant_name', 'contact',
            'spiritual_commitment', 'biblical_knowledge'
        ];

        const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

        // ======= Countries (sorted) =======
        const countries = [
            "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia",
            "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium",
            "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria",
            "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad",
            "Chile", "China", "Colombia", "Comoros", "Congo", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic",
            "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea",
            "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany",
            "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary",
            "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan",
            "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia",
            "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta",
            "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro",
            "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger",
            "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Panama", "Papua New Guinea",
            "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis",
            "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia",
            "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia",
            "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria",
            "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey",
            "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay",
            "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
        ];

        // Populate nationality select
        const nationalitySelect = document.getElementById('nationality');
        if (nationalitySelect) {
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.toLowerCase().replace(/ /g, '_');
                option.textContent = country;
                nationalitySelect.appendChild(option);
            });
        }

        // Character counter for comments
        if (commentsTextarea && charCount) {
            commentsTextarea.addEventListener('input', function () {
                const count = this.value.length;
                charCount.textContent = `${count} / 1000 characters`;
                charCount.style.color = count > 900 ? '#dc3545' : '#666';
            });
        }

        // Touched fields tracking
        const touchedFields = {};

        // Add event listeners for validation
        requiredFields.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;

            el.addEventListener('input', () => {
                touchedFields[id] = true;
                validateField(id);
                validateForm();
            });

            el.addEventListener('blur', () => {
                touchedFields[id] = true;
                validateField(id);
            });
        });

        // Validation functions
        function validateEmail(id) {
            const el = document.getElementById(id);
            const errorBox = document.getElementById(id + '_error');
            if (!el || !errorBox) return true;

            const val = el.value.trim();

            if (!touchedFields[id]) {
                clearError(el, errorBox);
                return false;
            }

            if (!val) {
                showError(el, errorBox, 'This field is required');
                return false;
            }
            if (!emailPattern.test(val)) {
                showError(el, errorBox, 'Invalid email format');
                return false;
            }

            clearError(el, errorBox);
            return true;
        }

        function validatePhone(id) {
            const el = document.getElementById(id);
            const errorBox = document.getElementById(id + '_error');
            if (!el || !errorBox) return true;

            const raw = el.value.trim();

            // Optional field → allow empty
            if (raw === "") {
                clearError(el, errorBox);
                return true;
            }

            // Validate only after touched
            if (!touchedFields[id]) {
                clearError(el, errorBox);
                return false;
            }

            // Must contain digits only
            const digits = raw.replace(/\D/g, '');
            if (digits !== raw) {
                showError(el, errorBox, 'Only digits are allowed');
                return false;
            }

            // Length 7–15 digits
            if (digits.length < 7 || digits.length > 15) {
                showError(el, errorBox, 'Phone number must be 7–15 digits');
                return false;
            }

            clearError(el, errorBox);
            return true;
        }

        function validateField(id) {
            const el = document.getElementById(id);
            const errorBox = document.getElementById(id + '_error');
            if (!el || !errorBox) return true;

            // SPECIAL HANDLING — skip contact here
            if (id === 'contact') {
                return validatePhone(id);
            }

            const val = el.value.trim();
            let error = '';

            if (!val) error = 'This field is required';

            if (!error && id === 'email' && val && !emailPattern.test(val)) {
                error = 'Invalid email format';
            }

            if (error && touchedFields[id]) {
                showError(el, errorBox, error);
                return false;
            } else {
                clearError(el, errorBox);
                if (val) el.classList.add('input-valid');
                else el.classList.remove('input-valid');
                return error === '';
            }
        }
        function showError(el, box, message) {
            el.classList.add('input-error');
            el.classList.remove('input-valid');
            box.textContent = message;
            box.style.display = 'block';
        }

        function clearError(el, box) {
            el.classList.remove('input-error');
            box.textContent = '';
            box.style.display = 'none';
        }

        function validateForm() {
            let allValid = true;

            for (const id of requiredFields) {
                if (id === 'email') {
                    if (!validateEmail(id)) allValid = false;
                } else if (id === 'contact') {
                    if (!validatePhone(id)) allValid = false;
                } else {
                    if (!validateField(id)) allValid = false;
                }
            }

            if (submitBtn) submitBtn.disabled = !allValid;
            return allValid;
        }

        // Initial state
        submitBtn.disabled = true;

        // Form submission
        if (form) {
            form.addEventListener('submit', function (e) {
                requiredFields.forEach(id => touchedFields[id] = true);

                if (!validateForm()) {
                    e.preventDefault();
                    const firstError = document.querySelector('.input-error');
                    if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    alert('Please fill in all required fields correctly.');
                    return;
                }

                // reCAPTCHA check
                if (typeof grecaptcha !== 'undefined') {
                    const recaptchaResponse = grecaptcha.getResponse();
                    if (!recaptchaResponse) {
                        e.preventDefault();
                        alert('Please complete the reCAPTCHA verification.');
                        return;
                    }
                }
            });
        }
    });
</script>
{% endblock %}