{% extends 'site_pages/index.html' %}
{% block content %}
<style>
    
    body {
        background: #d7eaff !important;
        margin: 0;
        padding: 0;
    }

    /* Application Container - Full width blue background */
    .application-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 20px;
        background: transparent;
        /* Remove container background */
        min-height: 100vh;
        margin-top: -120px !important;
        padding-top: 180px !important;

    }

    .application-header {
        text-align: center;
        margin-bottom: 40px;
        padding-top: 20px;
    }

    .application-header h1 {
        color: var(--dark-navy);
        font-size: 1.9rem !important;
        margin-bottom: 10px;
        font-weight: 700;
    }

    .application-header p {
        color: var(--text-gray);
        font-size: 0.9rem !important;
    }
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .application-container {
            margin-top: -80px !important;
            padding-top: 140px !important;
            padding-left: 15px;
            padding-right: 15px;
        }

        .application-header h1 {
            font-size: 1.75rem !important;
        }

        .section-reference-title h5 {
            font-size: 16px !important;
        }

        .application-header p {
            font-size: 1rem;
        }
    }

    @media (max-width: 576px) {
        .application-container {
            padding-top: 130px !important;
        }

        .application-header h1 {
            font-size: 1.75rem !important;
        }

        .section-reference-title h5 {
            font-size: 16px !important;
        }
    }

    

    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alert-success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
    }

    .alert-error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }

    .alert i {
        font-size: 1.2rem;
    }


    .progress-tracker {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        padding: 0 20px;
        position: relative;
    }

    .progress-tracker::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 3px;
        background: #e5e7eb;
        z-index: 0;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 1;
        background: white;
        padding: 0 10px;
    }

    .progress-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #9ca3af;
        margin-bottom: 8px;
        transition: all 0.3s;
    }

    /* Progress tracker */
    .progress-tracker {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        padding: 0 20px;
        position: relative;
        background: transparent;
    }

    .progress-tracker::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 3px;
        background: #e5e7eb;
        z-index: 0;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 1;
        background: transparent;
        /* Remove white background */
        padding: 0;
        /* Remove padding */
    }

    .progress-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #9ca3af;
        margin-bottom: 8px;
        transition: all 0.3s;
    }

    .progress-step.active .progress-circle {
        background: var(--primary-cyan);
        color: white;
    }

    .progress-step.completed .progress-circle {
        background: #10b981;
        color: white;
    }

    .progress-label {
        font-size: 0.85rem;
        color: var(--text-gray);
        text-align: center;
        background: transparent;
        /* Ensure label background is transparent */
    }


    .progress-step.active .progress-circle {
        background: var(--primary-cyan);
        color: white;
    }

    .progress-step.completed .progress-circle {
        background: #10b981;
        color: white;
    }

    .progress-label {
        font-size: 0.85rem;
        color: var(--text-gray);
        text-align: center;
    }

    .form-section {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
    }

    .section-title {
        color: var(--dark-navy);
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 50px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--primary-cyan);
        gap: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        text-align: center;
    }


    .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-row.two-cols {
        grid-template-columns: repeat(2, 1fr);
    }

    .form-row.three-cols {
        grid-template-columns: repeat(3, 1fr);
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    .form-group label .required {
        color: #ef4444;
        margin-left: 2px;
    }

    .form-control,
    .form-select {
        width: 100%;
        padding: 12px 16px;
        font-size: 15px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        outline: none;
        transition: all 0.2s;
        color: #374151;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary-cyan);
        box-shadow: 0 0 0 3px rgba(0, 206, 209, 0.1);
    }

    .form-control.error {
        border-color: #ef4444;
    }

    textarea.form-control {
        min-height: 120px;
        resize: vertical;
    }

    .file-upload-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
    }

    .file-upload-input {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
        width: 100%;
        height: 100%;
    }

    .file-upload-label {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px 16px;
        background: #f9fafb;
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .file-upload-label:hover {
        border-color: var(--primary-cyan);
        background: var(--light-cyan);
    }

    .file-upload-label i {
        margin-right: 8px;
        color: var(--primary-cyan);
    }

    .phone-group {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 10px;
    }

    .btn-group {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        margin-bottom: 60px;
        /* Add space at bottom */
        padding-bottom: 40px;
        /* Extra padding for better spacing */
    }

    .btn-primary,
    .btn-secondary {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--purple-gradient-start), var(--purple-gradient-end));
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(167, 139, 250, 0.4);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background: #64748B !important;
        color: white
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .info-text {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 5px;
    }


    /* Icon style */
    .section-icon {
        font-size: 28px;
        background: linear-gradient(90deg, var(--primary-cyan), var(--purple-gradient-start));
        -webkit-background-clip: text;
        color: transparent;
        /* Main theme color */
        min-width: 28px;
        /* Prevent shifting if icons vary */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Optional: Hover Color Effect */
    .section-title:hover .section-icon {
        color: #0056b3;
    }

    .g-recaptcha iframe {
        width: 100% !important;
        min-height: 78px;
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* Responsive for small screens */
    @media (max-width: 576px) {
        .section-title {
            font-size: 18px;
        }

        .section-icon {
            font-size: 18px;
        }

        .application-header p {
            font-size: 14px;
        }

        .btn-group {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            width: 100% !important;
            margin-top: 30px;
        }

        .btn-group button {
            max-width: 150px;
            white-space: nowrap;
            padding: 6px 14px;

        }

        .btn-group .btn-primary,
        .btn-group .btn-secondary {
            padding: 6px 14px;
            /* smaller height + width */
            font-size: 14px;
            /* reduce text size */
            border-radius: 6px;
            /* optional: smaller corners */
        }


    }


    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @media (max-width: 768px) {

        .form-row.two-cols,
        .form-row.three-cols {
            grid-template-columns: 1fr;
        }

        .btn-group {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            width: 100% !important;
            margin-top: 30px;
        }

        .btn-group button {
            max-width: 150px;
            white-space: nowrap;
            padding: 6px 14px;

        }

        .application-header p {
            font-size: 14px;
        }


        .btn-group .btn-primary,
        .btn-group .btn-secondary {
            padding: 6px 14px;
            /* smaller height + width */
            font-size: 14px;
            /* reduce text size */
            border-radius: 6px;
            /* optional: smaller corners */
        }



        .phone-group {
            grid-template-columns: 100px 1fr;
        }

        .progress-tracker {
            padding: 0 10px;
        }

        .progress-label {
            font-size: 0.75rem;
        }

        .application-header h1 {
            font-size: 2rem;
        }

        .form-section {
            padding: 20px;
        }

        .btn-group {
            flex-direction: column;
        }

        .btn-primary,
        .btn-secondary {
            width: 100%;
        }
    }
</style>

<div class="application-container">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <div class="application-header">
        <h1>Reference Submission</h1>
        <p>Use this form to submit a reference for an applicant. Fields marked with <span
                class="required">*</span> are required.</p>
    </div>

    <!-- Messages -->
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        <i class="bi bi-{% if message.tags == 'success' %}check-circle{% else %}exclamation-circle{% endif %}"></i>
        <span>{{ message }}</span>
    </div>
    {% endfor %}
    {% endif %}

    <!-- Progress Tracker -->
    <div class="progress-tracker">
        <div class="progress-step active">
            <div class="progress-circle">1</div>
            <span class="progress-label">Referee Info</span>
        </div>
        <div class="progress-step">
            <div class="progress-circle">2</div>
            <span class="progress-label">Applicant Info</span>
        </div>
        <div class="progress-step">
            <div class="progress-circle">3</div>
            <span class="progress-label">Applicant Assessment</span>
        </div>
        <div class="progress-step">
            <div class="progress-circle">4</div>
            <span class="progress-label">Additional Comments</span>
        </div>        
    </div>

    <form method="POST" enctype="multipart/form-data" id="studentApplicationForm">
        {% csrf_token %}

        <!-- Section 1: Referee Information -->
        <div class="form-section">
            <h2 class="section-title"> <i class="fas fa-user-tie section-icon"></i>
                Referee Information</h2>

                <div class="form-row three-cols">
                    <div class="form-group">
                        <label>First Name <span class="required">*</span></label>
                        <input type="text" name="first_name" class="form-control"
                            value="{{ request.POST.first_name|default:'' }}" required>
                    </div>
                    <div class="form-group">
                        <label>Middle Name</label>
                        <input type="text" name="middle_name" class="form-control"
                            value="{{ request.POST.middle_name|default:'' }}">
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" name="last_name" class="form-control"
                            value="{{ request.POST.last_name|default:'' }}">
                    </div>
                </div>

                <div class="form-row two-cols">
                    <div class="form-group">
                        <label>Email <span class="required">*</span></label>
                        <input type="email" name="email" class="form-control"
                            value="{{ request.POST.email|default:'' }}" required>
                    </div>
                    <div class="form-group">
                        <label>Citizenship <span class="required">*</span></label>
                        <select name="citizenship" class="form-select" required>
                            <option value="">Select Country</option>
                            {% for country in countries %}
                            <option value="{{ country.id }}">{{ country.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>                
                <div class="form-group">
                    <label>Phone Number <span class="required">*</span></label>
                    <div class="phone-group">
                        <select id="phone_code" name="phone_code" class="form-select" required>
                            <option value="">Code</option>
                            {% for country in countries %}
                            <option value="{{ country.phonecode }}">
                                {{ country.name }} (+{{ country.phonecode }})
                            </option>
                            {% endfor %}
                        </select>
                        <input type="tel" name="phone_number" class="form-control"
                            value="{{ request.POST.phone_number|default:'' }}" required placeholder="Phone Number">
                    </div>
                    <small id="phone_number_error" class="error-message"></small>
                </div>
                
        </div>

        <!-- Section 2: Applicant Information -->
        <div class="form-section">
            <h2 class="section-title"> <i class="fas fa-id-card section-icon"></i>Applicant Information</h2>
             <div class="form-row two-cols">
                    <div class="form-group">
                        <label>Name of Applicant <span class="required">*</span></label>
                        <input type="applicant_name" name="applicant_name" class="form-control"
                            value="{{ request.POST.applicant_name|default:'' }}" required>
                             <small class="error-message" id="applicant_name_error"></small>
                    </div>
                    <div class="form-group">
                        <label>Your Relationship with the Applicant <span class="required">*</span></label>
                        <select name="relationship" class="form-select" required>
                            <option value="">--- Select ---</option>
                            <option value="pastor">Pastor</option>
                            <option value="teacher">Teacher/Professor</option>
                            <option value="employer">Employer</option>
                            <option value="colleague">Colleague</option>
                            <option value="friend">Friend</option>
                            <option value="relative">Relative</option>
                            <option value="mentor">Mentor</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>       
            <div class="form-group">
                <label>Since when you know this Applicant <span class="required">*</span></label>
                <input type="text" name="known_since" placeholder="e.g., January 2020 or 5 years" class="form-control"
                    value="{{ request.POST.known_since|default:'' }}" required>
                    <small class="error-message" id="known_since_error"></small>
            </div>                 
        </div>

        <!-- Section 3: Applicant Assessment -->
        <div class="form-section">
            <h2 class="section-title"> <i class="fas fa-clipboard-check section-icon"></i>Applicant Assessment</h2>

            <div class="form-row two-cols">
                <div class="form-group">
                        <label>Spiritual Commitment <span class="required">*</span></label>
                        <select name="spiritual_commitment" class="form-select" required>
                            <option value="">--- Select ---</option>
                            <option value="excellent">Excellent</option>
                            <option value="very_good">Very Good</option>
                            <option value="good">Good</option>
                            <option value="average">Average</option>
                            <option value="below_average">Below Average</option>
                        </select>
                        <small class="error-message" id="spiritual_commitment_error"></small>
                </div>
                <div class="form-group">
                        <label>Learning Capacity<span class="required">*</span></label>
                        <select name="learning_capacity" class="form-select" required>
                            <option value="">--- Select ---</option>
                            <option value="excellent">Excellent</option>
                            <option value="very_good">Very Good</option>
                            <option value="good">Good</option>
                            <option value="average">Average</option>
                            <option value="below_average">Below Average</option>
                        </select>
                        <small class="error-message" id="learning_capacity_error"></small>
                </div>             
            </div>

            <div class="form-row two-cols">
                <div class="form-group">
                    <label>Dedication for Lord's Ministry</label>
                    <select id="dedication" name="dedication" class="form-select">
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="leadership">Leadership Skills</label>
                    <select id="leadership" name="leadership" class="form-select">
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                </div>
            </div>

            <div class="form-row two-cols">
                <div class="form-group">
                    <label for="church_involvement">Church Involvement</label>
                    <select id="church_involvement" name="church_involvement" class="form-select">
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="biblical_knowledge">Biblical Knowledge <span class="required">*</span></label>
                    <select id="biblical_knowledge" name="biblical_knowledge" class="form-select" required>
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                    <small class="error-message" id="biblical_knowledge_error"></small>
                </div>
            </div>
            <div class="form-row two-cols">
                <div class="form-group">
                    <label for="moral_standard">Moral Standard</label>
                    <select id="moral_standard" name="moral_standard" class="form-select">
                        <option value="">--- Select ---</option>
                        <option value="excellent">Excellent</option>
                        <option value="very_good">Very Good</option>
                        <option value="good">Good</option>
                        <option value="average">Average</option>
                        <option value="below_average">Below Average</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="recommendation">Recommendation</label>
                    <select id="recommendation" name="recommendation" class="form-select">
                        <option value="">--- Select ---</option>
                        <option value="highly_recommend">Highly Recommend</option>
                        <option value="recommend">Recommend</option>
                        <option value="recommend_with_reservation">Recommend with Reservation</option>
                        <option value="do_not_recommend">Do Not Recommend</option>
                    </select>
                </div>
            </div>
           
            <div class="form-group">
                <label for="financial_condition">Financial Condition</label>
                <select id="financial_condition" name="financial_condition" class="form-select">
                    <option value="">--- Select ---</option>
                    <option value="excellent">Excellent</option>
                    <option value="very_good">Very Good</option>
                    <option value="good">Good</option>
                    <option value="average">Average</option>
                    <option value="below_average">Below Average</option>
                </select>
            </div>            
        </div>

        <!-- Section 4: Additional Comments -->
        <div class="form-section">
            <h2 class="section-title"> <i class="fas fa-comments section-icon"></i>Additional Comments</h2>

            <div class="form-field full-width">
                <label for="comments">Personal Comment for this Applicant</label>
                <textarea id="comments" name="comments" rows="6" maxlength="1000"
                    placeholder="Additional insights about the applicant"></textarea>
                <small class="character-count">0 / 1000 characters</small>
            </div>
            <div class="g-recaptcha" data-sitekey="{{ RECAPTCHA_SITE_KEY }}"></div>
            <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                This Reference Form will be strictly confidential and will not be shown to Applicant or any other
                person.
                By clicking "Submit", you agree that the information given is true to your knowledge.
            </p>
            <!-- Submit & Cancel -->
            <div class="btn-group">
                <button type="button" class="btn-secondary" onclick="window.history.back()">Cancel</button>
                <button type="submit" class="btn-primary" id="submitBtn">Submit Application</button>
            </div>
        </div>
</div>

</form>
</div>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<script>
    // File upload label update
    document.querySelectorAll('.file-upload-input').forEach(input => {
        input.addEventListener('change', function (e) {
            const label = this.parentElement.querySelector('.file-upload-label span');
            if (this.files.length > 0) {
                label.textContent = this.files[0].name;
            }
        });
    });
    // Timezone population
    document.addEventListener("DOMContentLoaded", function () {
        const select = document.getElementById("timezone");
        const selectedValue = document.getElementById("selected_timezone").value;

        TIMEZONE_LIST.forEach(tz => {
            const option = document.createElement("option");
            option.value = tz;
            option.textContent = tz.replace("_", " "); // nicer display

            if (tz === selectedValue) {
                option.selected = true;
            }

            select.appendChild(option);
        });
    });

    // Form submission with loading
    document.getElementById('studentApplicationForm').addEventListener('submit', function (e) {
        const requiredFields = this.querySelectorAll('[required]');
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone").value.trim();
        let isValid = true;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('error');
            } else {
                field.classList.remove('error');
            }
        });
        $(document).ready(function () {
            $('#phone_code').select2({
                placeholder: "Search code or country",
                allowClear: true
            });
        });
        const phoneRegex = /^[6-9]\d{9}$/;
        if (!phone || !phoneRegex.test(phone)) {
            valid = false;
            errors.push("Enter a valid 10-digit phone number (starts with 6-9).");
        }
        if (!email || !emailRegex.test(email)) {
            valid = false;
            errors.push("Enter a valid email address.");
        }
        if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields.');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            // Show loading overlay
            document.getElementById('loadingOverlay').classList.add('active');
            document.getElementById('submitBtn').disabled = true;
        }
    });

    // Progress tracking on scroll
    window.addEventListener('scroll', function () {
        const sections = document.querySelectorAll('.form-section');
        const progressSteps = document.querySelectorAll('.progress-step');

        sections.forEach((section, index) => {
            const rect = section.getBoundingClientRect();
            if (rect.top < window.innerHeight / 2 && rect.bottom > 0) {
                progressSteps.forEach((step, stepIndex) => {
                    if (stepIndex <= index) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });
            }
        });
    });
</script>
{% endblock %}