{% extends "site_pages/index.html" %}

{% block title %}
<title>Reference Form - Trinity Theological Seminary</title>
{% endblock %}

{% block content %}
<section class="reference-section">
    <div class="container">
        <h2 class="section-title">Reference <span class="highlight">Form</span></h2>

        <!-- Intro -->
        <div class="intro-section">
            <p>
                Thank you for providing a reference for a prospective student at Trinity Theological Seminary.
                Your honest assessment will help us evaluate the applicant's suitability for our programs.
                All information will be kept strictly confidential.
            </p>
        </div>

        <!-- Form Wrapper -->
        <div class="reference-form-wrapper">
            <form method="POST" action="" class="reference-form" novalidate>
                {% csrf_token %}

                <!-- Your Info -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-referee"></i> REFEREE INFORMATION
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="first_name">First Name <span class="required">*</span></label>
                            <input type="text" id="first_name" name="first_name" placeholder="Enter your first name">
                            <span class="error-msg" id="first_name_error"></span>
                        </div>
                        <div class="form-group">
                            <label for="middle_name">Middle Name</label>
                            <input type="text" id="middle_name" name="middle_name" placeholder="Optional">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="last_name">Last Name <span class="required">*</span></label>
                            <input type="text" id="last_name" name="last_name" placeholder="Enter your last name">
                            <span class="error-msg" id="last_name_error"></span>
                        </div>
                        <div class="form-group">
                            <label for="email">Email <span class="required">*</span></label>
                            <input type="email" id="email" name="email" placeholder="your.email@example.com">
                            <span class="error-msg" id="email_error"></span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contact">Contact Number <span class="required">*</span></label>
                            <input type="tel" id="contact" name="contact" placeholder="(555) 123-4567">
                            <span class="error-msg" id="contact_error"></span>
                        </div>
                        <div class="form-group">
                            <label for="nationality">Nationality <span class="required">*</span></label>
                            <select id="nationality" name="nationality">
                                <option value="">--- Select Country ---</option>
                            </select>
                            <span class="error-msg" id="nationality_error"></span>
                        </div>
                    </div>
                </div>

                <!-- Applicant Info -->
                <div class="form-section">
                     <div class="section-header">
                        <i class="fas fa-referee"></i> APLICANT INFORMATION
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="applicant_name">Name of Applicant <span class="required">*</span></label>
                            <input type="text" id="applicant_name" name="applicant_name"
                                placeholder="Full name of the applicant">
                            <span class="error-msg" id="applicant_name_error"></span>
                        </div>
                        <div class="form-group">
                            <label for="relationship">Your Relationship <span class="required">*</span></label>
                            <select id="relationship" name="relationship">
                                <option value="">--- Select ---</option>
                                <option value="pastor">Pastor</option>
                                <option value="teacher">Teacher/Professor</option>
                                <option value="employer">Employer</option>
                                <option value="colleague">Colleague</option>
                                <option value="friend">Friend</option>
                                <option value="relative">Relative</option>
                                <option value="mentor">Mentor</option>
                                <option value="other">Other</option>
                            </select>
                            <span class="error-msg" id="relationship_error"></span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="known_since">Since when you know this Applicant <span
                                    class="required">*</span></label>
                            <input type="text" id="known_since" name="known_since"
                                placeholder="e.g., January 2020 or 5 years">
                            <span class="error-msg" id="known_since_error"></span>
                        </div>
                    </div>
                </div>

                <!-- Assessment Section -->
                <div class="form-section">
                     <div class="section-header">
                        <i class="fas fa-referee"></i> APPLICANT ASSESSMENT
                    </div>                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="spiritual_commitment">Spiritual Commitment <span
                                    class="required">*</span></label>
                            <select id="spiritual_commitment" name="spiritual_commitment">
                                <option value="">--- Select ---</option>
                                <option value="excellent">Excellent</option>
                                <option value="very_good">Very Good</option>
                                <option value="good">Good</option>
                                <option value="average">Average</option>
                                <option value="below_average">Below Average</option>
                            </select>
                            <span class="error-msg" id="spiritual_commitment_error"></span>
                        </div>
                        <div class="form-group">
                            <label for="dedication">Dedication for Ministry <span class="required">*</span></label>
                            <select id="dedication" name="dedication">
                                <option value="">--- Select ---</option>
                                <option value="excellent">Excellent</option>
                                <option value="very_good">Very Good</option>
                                <option value="good">Good</option>
                                <option value="average">Average</option>
                                <option value="below_average">Below Average</option>
                            </select>
                            <span class="error-msg" id="dedication_error"></span>
                        </div>
                    </div>

                    <!-- Add remaining assessment fields here: learning_capacity, church_involvement, leadership, moral_standard, biblical_knowledge, financial_condition, recommendation -->
                </div>

                <!-- Additional Comments -->
                <div class="form-section">
                     <div class="section-header">
                        <i class="fas fa-referee"></i> ADDITIONAL COMMENTS
                    </div>
                    <div class="form-group full-width">
                        <label for="comments">Comments</label>
                        <textarea id="comments" name="comments" rows="6"
                            placeholder="Additional insights about the applicant"></textarea>
                        <small class="character-count">0 / 1000 characters</small>
                    </div>
                </div>

                <!-- reCAPTCHA -->
                <div class="form-section verification-section">
                    <div class="recaptcha-container">
                        <div class="g-recaptcha" data-sitekey="your-site-key"></div>
                    </div>
                </div>

                <!-- Submit -->
                <div class="form-submit">
                    <button type="submit" class="btn-submit" id="submitBtn">
                        <span class="btn-text">SUBMIT</span>
                        <span class="btn-icon">â†’</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

<!--<script src="https://www.google.com/recaptcha/api.js" async defer></script>-->

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('.reference-form');
        const submitBtn = document.getElementById('submitBtn');
        const commentsTextarea = document.getElementById('comments');
        const charCount = document.querySelector('.character-count');

        const requiredFields = [
            'first_name', 'last_name', 'email', 'nationality',
            'applicant_name', 
            'spiritual_commitment', 'dedication'
            // add remaining assessment field ids here
        ];

        const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

        // Country dropdown
        const countries = ["Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda",
            "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados",
            "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil",
            "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic",
            "Chad", "Chile", "China", "Colombia", "Comoros", "Congo", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic",
            "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea",
            "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany",
            "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary",
            "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan",
            "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia",
            "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali",
            "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia",
            "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand",
            "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau",
            "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania",
            "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa",
            "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone",
            "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan",
            "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania",
            "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan",
            "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan",
            "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"];

        const nationalitySelect = document.getElementById('nationality');
        countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country.toLowerCase().replace(/ /g, '_');
            option.textContent = country;
            nationalitySelect.appendChild(option);
        });

        // Character counter
        if (commentsTextarea && charCount) {
            commentsTextarea.addEventListener('input', function () {
                const count = this.value.length;
                charCount.textContent = `${count} / 1000 characters`;
                charCount.style.color = count > 900 ? '#dc3545' : '#666';
            });
        }

        // Field validation
        requiredFields.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', () => { validateField(id); validateForm(); });
                el.addEventListener('blur', () => { validateField(id); });
            }
        });

        function validateField(id) {
            const el = document.getElementById(id);
            const errorBox = document.getElementById(id + '_error');
            if (!el || !errorBox) return true;

            let error = '';
            const val = el.value.trim();

            if (!val) error = 'This field is required';
            if (id === 'email' && val && !emailPattern.test(val)) error = 'Invalid email format';
            if (id === 'contact' && val) {
                if (!/^[\d\s\-\(\)]+$/.test(val)) error = 'Digits only';
                else if (val.replace(/\D/g, '').length < 7 || val.replace(/\D/g, '').length > 15) error = 'Phone number must be 7-15 digits';
            }

            if (error) { el.classList.add('input-error'); el.classList.remove('input-valid'); errorBox.textContent = error; errorBox.style.display = 'block'; return false; }
            else { el.classList.remove('input-error'); el.classList.add('input-valid'); errorBox.textContent = ''; errorBox.style.display = 'none'; return true; }
        }

        function validateForm() {
            let allValid = true;
            requiredFields.forEach(id => { if (!validateField(id)) allValid = false; });
            submitBtn.disabled = !allValid;
            return allValid;
        }

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            if (!validateForm()) {
                const firstError = document.querySelector('.input-error');
                if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                alert('Please fill in all required fields correctly.');
                return;
            }

            if (typeof grecaptcha !== 'undefined') {
                const recaptchaResponse = grecaptcha.getResponse();
                if (!recaptchaResponse) { alert('Please complete the reCAPTCHA verification.'); return; }
            }

            this.submit();
        });
        
    });
</script>



<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('.reference-form');
    const submitBtn = document.getElementById('submitBtn');
    const commentsTextarea = document.getElementById('comments');
    const charCount = document.querySelector('.character-count');

    const requiredFields = [
        'first_name', 'last_name', 'email', 'contact', 'nationality',
        'applicant_name', 'relationship', 'known_since',
        'spiritual_commitment', 'dedication'
        // add remaining assessment field ids here
    ];

    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

    // Country dropdown
    const countries = ["Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda",
            "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados",
            "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil",
            "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic",
            "Chad", "Chile", "China", "Colombia", "Comoros", "Congo", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic",
            "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea",
            "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany",
            "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary",
            "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan",
            "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia",
            "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali",
            "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia",
            "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand",
            "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau",
            "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania",
            "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa",
            "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone",
            "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan",
            "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania",
            "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan",
            "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan",
            "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"];
    const nationalitySelect = document.getElementById('nationality');
    countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country.toLowerCase().replace(/ /g, '_');
        option.textContent = country;
        nationalitySelect.appendChild(option);
    });

    // Character counter
    if (commentsTextarea && charCount) {
        commentsTextarea.addEventListener('input', function () {
            const count = this.value.length;
            charCount.textContent = `${count} / 1000 characters`;
            charCount.style.color = count > 900 ? '#dc3545' : '#666';
        });
    }

    // ------------------------------
    // Validation with "touchedFields"
    // ------------------------------
    const touchedFields = {};

    requiredFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', () => { 
                touchedFields[id] = true; 
                validateField(id); 
                validateForm(); 
            });
            el.addEventListener('blur', () => { 
                touchedFields[id] = true; 
                validateField(id); 
            });
        }
    });

    function validateField(id) {
        const el = document.getElementById(id);
        const errorBox = document.getElementById(id + '_error');
        if (!el || !errorBox) return true;

        const val = el.value.trim();
        let error = '';

        if (!val) error = 'This field is required';
        if (id === 'email' && val && !emailPattern.test(val)) error = 'Invalid email format';
        if (id === 'contact' && val) {
            if (!/^[\d\s\-\(\)]+$/.test(val)) error = 'Digits only';
            else if (val.replace(/\D/g, '').length < 7 || val.replace(/\D/g, '').length > 15)
                error = 'Phone number must be 7-15 digits';
        }

        // Only show error if field has been touched
        if (error && touchedFields[id]) {
            el.classList.add('input-error');
            el.classList.remove('input-valid');
            errorBox.textContent = error;
            errorBox.style.display = 'block';
            return false;
        } else {
            el.classList.remove('input-error');
            if (val) el.classList.add('input-valid');
            errorBox.textContent = '';
            errorBox.style.display = 'none';
            return true;
        }
    }

    function validateForm() {
        let allValid = true;
        requiredFields.forEach(id => { if (!validateField(id)) allValid = false; });
        submitBtn.disabled = !allValid;
        return allValid;
    }

    form.addEventListener('submit', function (e) {
        e.preventDefault();
        if (!validateForm()) {
            const firstError = document.querySelector('.input-error');
            if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            alert('Please fill in all required fields correctly.');
            return;
        }

        if (typeof grecaptcha !== 'undefined') {
            const recaptchaResponse = grecaptcha.getResponse();
            if (!recaptchaResponse) { alert('Please complete the reCAPTCHA verification.'); return; }
        }

        this.submit();
    });
});
</script>
{% endblock %}